---
title: "カスタムデータベース接続の構造に関するベストプラクティス"
permalink: "anatomy"
'description': "カスタムデータベース接続の構造に関するベストプラクティスについて説明します。"
'og:title': "カスタムデータベース接続の構造に関するベストプラクティス"
'og:description': "カスタムデータベース接続の構造に関するベストプラクティスについて説明します。"
'og:image': "https://cdn2.auth0.com/docs/1.14567.0/img/share-image.png"
'twitter:title': "カスタムデータベース接続の構造に関するベストプラクティス"
'twitter:description': "カスタムデータベース接続の構造に関するベストプラクティスについて説明します。"
---

カスタムデータベース接続は通常、独自のレガシーIDストアにアクセスして認証（**レガシー認証** と呼ばれることがあります）や[自動移行によるユーザーのインポート](/ja-jp/manage-users/user-migration/configure-automatic-migration-from-your-database)（** トリクルダウン移行** または **レイジー移行** と呼ばれます）を行うために使用されます。カスタムデータベース接続は、Auth0のマルチテナントアーキテクチャを使用するシナリオで、Auth0テナントへのプロキシアクセスにも使うことができます。詳細については、「[複数テナントのアプリケーションに関するベストプラクティス](/ja-jp/get-started/auth0-overview/create-tenants/multi-tenant-apps-best-practices)」をお読みください。

カスタムデータベース接続の作成や構成には通常、<Tooltip data-tooltip-id="react-containers-DefinitionTooltip-0" href="/ja-jp/glossary?term=auth0-dashboard" tip="Auth0 Dashboard: サービスを構成するためのAuth0の主製品。" cta="用語集の表示">Auth0 Dashboard</Tooltip>が使用されます。データベース接続を作成してから、**［Use my own database（独自のデータベースを使用する）］** を有効にして、データベースのアクションスクリプトを編集できるようにします。カスタムデータベース接続の作成や構成には、Auth0 <Tooltip data-tooltip-id="react-containers-DefinitionTooltip-0" href="/ja-jp/glossary?term=management-api" tip="Management API: 顧客が管理タスクを実行できるようにするための製品。" cta="用語集の表示">Management API</Tooltip>の[接続作成エンドポイント](https://auth0.com/docs/api/management/v2#!/Connections/post_connections)と`auth0`ストラテジーを使うこともできます。

<Frame>![Auth0 Dashboard 認証 データベース接続 カスタムデータベース設定 独自のデータベース使用有効](/images/ja-jp/cdy7uua7fh8z/11HPAdVwJMmnWbzMVjHCJ8/e8a63cd05212da39164cab0114d1f89b/2025-02-27_17-26-24.png)</Frame>

下の図が示すように、カスタムデータベース接続をログインワークフローに使用して、認証やユーザーのインポートを行うために、ユーザーのID情報が独自のレガシーIDストアから取得できるようにします。

<Frame>![カスタムデータベース接続のフロー](/images/ja-jp/cdy7uua7fh8z/1H2Ky1WyPlZ9zHZrEVlFhP/fd6a1b202636394f5d129fddd3787684/custom-database-connections.png)</Frame>

すべてのデータベース接続タイプに共通なアーティファクトに加えて、カスタムデータベース接続を使用すると、アクションスクリプトを構成できるようになります。アクションスクリプトとは、レガシーIDストアとのやり取りに使用されるカスタムコードのことです。構成にどのスクリプトを選ぶかは、作成する接続の用途がレガシー認証なのか、それとも自動移行なのかに依存します。

アクションスクリプトは無名関数として実装できますが、無名関数にすると、デバッグを行う際に、生成されたコールスタックを例外的なエラー条件の結果として解釈するのが難しくなります。利便性を考慮して、アクションスクリプトには関数名を付けることをお勧めします。推奨される名前の例については、「[カスタムデータベースのアクションスクリプト実行に関するベストプラクティス](/ja-jp/authenticate/database-connections/custom-db/custom-database-connections-scripts/execution)」をお読みください。

レガシー認証のシナリオでは、ユーザーレコードは新規作成されません。ユーザーは引き続きレガシーIDストアで管理され、ユーザーの認証時にAuth0はそのIDを使用します。カスタムデータベース接続は、ユニバーサルログインワークフローの外部でも使用されます。たとえば、レガシーのIDストアにいるユーザーに対してパスワード変更操作が行われると、接続の`changePassword`アクションスクリプトが呼び出されます。

## 自動移行

自動移行では、Auth0は新しいユーザーをAuth0管理のIDストア（データベース）内に作成します。Auth0がユーザーを認証する際には、Auth0管理のIDストアにあるIDが使用されます。これを行うために、Auth0は、レガシーIDストアに対照してユーザーが認証されることを要求します。この認証に成功した場合にのみ、Auth0はAuth0管理のデータベース内に新しいユーザーを作成します。新しいユーザーの作成には、認証中に提供されたのと同じIDとパスワードが使用されます。

自動移行のシナリオでは、ユーザーの作成は通常、ログインアクションスクリプトが完了した後で実行されます。ユーザーをレガシーIDストアから削除する際には、ログインスクリプト内でインライン操作として行うのではなく、独立処理として行うことをお勧めします。そうすることで、ユーザーを誤って削除したために、移行でエラー条件が発生することを防ぎます。

自動移行では、ユーザーは引き続きレガシーIDストアで管理され、必要に応じて削除やアーカイブを行うことができます。これに関する弊害は、ユーザーがAuth0から削除されても、レガシーデータストアに存在したままになることです。このときに、削除されたユーザーがログインしようとすると、ログインまたはユーザー取得スクリプトが実行され、そのユーザーがレガシーIDストアから再度移行されます。

ログインまたはユーザー取得スクリプトが完了する前か、レガシーストアが最終的に削除される前に、レガシーストアのユーザーIDに移行済のマークを付けて、意図的に削除したユーザーが思いがけず作成し直されてしまうことを防ぐようにお勧めします。

## サイズ

アクションスクリプトの実装では、総サイズが100　KBを上回らないことをお勧めします。Auth0プラットフォームでパッケージングと転送が処理されるため、サイズが大きいほど遅延が長くなります。そして、これはシステムの性能にも影響を与えます。100 KBの制限には、`require`ステートメントの一部として参照された可能性のある`npm`モジュールは含まれません。

## もっと詳しく

* [カスタムデータベース接続のセキュリティに関するベストプラクティス](/ja-jp/authenticate/database-connections/custom-db/custom-database-connections-scripts/connection-security)
* [カスタムデータベースのアクションスクリプトのベストプラクティス](/ja-jp/authenticate/database-connections/custom-db/custom-database-connections-scripts/execution)
* [カスタムデータベースアクションスクリプト環境のベストプラクティス](/ja-jp/authenticate/database-connections/custom-db/custom-database-connections-scripts/environment)