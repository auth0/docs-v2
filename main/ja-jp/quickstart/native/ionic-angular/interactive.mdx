---
title: "Capacitorを用いたIonic Angularアプリケーションにログインを追加する"
permalink: "interactive"
'description': "このガイドは、Ionic（Angular）とCapacitorのアプリケーションにAuth0 Angular SDKを使ってAuth0を統合する方法を説明します。"
'og:title': "Capacitorを用いたIonic Angularアプリケーションにログインを追加する"
'og:description': "このガイドは、Ionic（Angular）とCapacitorのアプリケーションにAuth0 Angular SDKを使ってAuth0を統合する方法を説明します。"
'og:image': "https://cdn2.auth0.com/docs/1.14567.0/media/platforms/ionic.jpeg"
'twitter:title': "Capacitorを用いたIonic Angularアプリケーションにログインを追加する"
'twitter:description': "このガイドは、Ionic（Angular）とCapacitorのアプリケーションにAuth0 Angular SDKを使ってAuth0を統合する方法を説明します。"
sidebarTitle: Ionic & Capacitor (Angular)
---

import { Recipe, Content, Section, SideMenu, SideMenuSectionItem, SignUpForm } from "/snippets/recipe.jsx";
import { LoggedInForm } from "/snippets/Login.jsx";
import AppModule from "/snippets/quickstart/native/ionic-angular/app.module.ts.mdx";
import AppComponent from "/snippets/quickstart/native/ionic-angular/app.component.ts.mdx";
import Loginbutton from "/snippets/quickstart/native/ionic-angular/login-button.ts.mdx";
import Logoutbutton from "/snippets/quickstart/native/ionic-angular/logout-button.ts.mdx";
import Userprofile from "/snippets/quickstart/native/ionic-angular/user-profile.ts.mdx";

export const sections = [
  { id: "使用を開始する", title: "使用を開始する" },
  { id: "auth0を構成する", title: "Auth0を構成する" },
  { id: "auth0-angular-sdkをインストールする", title: "Auth0 Angular SDKをインストールする" },
  { id: "認証モジュールを登録して構成する", title: "認証モジュールを登録して構成する" },
  { id: "アプリケーションにログインを追加する", title: "アプリケーションにログインを追加する" },
  { id: "ログインコールバックを処理する", title: "ログインコールバックを処理する" },
  { id: "アプリケーションにログアウトを追加する", title: "アプリケーションにログアウトを追加する" },
  { id: "ユーザープロファイルを表示する", title: "ユーザープロファイルを表示する" }
]

<Recipe>
  <Content>
    Auth0を使用すると、アプリケーションに手軽に認証を追加して、ユーザープロファイル情報にアクセスすることができます。このガイドは、Ionic（Angular）とCapacitorのアプリケーションに[Auth0 Angular SDK](https://github.com/auth0/auth0-angular)を使ってAuth0を統合する方法を説明します。

      <Section id={sections[0].id} title={sections[0].title} stepNumber="1">
      このクイックスタートは、[Ionic](https://ionicframework.com/)アプリケーションが[Capacitor](https://capacitorjs.com/)を使ってすでに実行されていることを前提としています。そうでない場合には、[IonicフレームワークでCapacitorを使用する](https://capacitorjs.com/docs/getting-started/with-ionic)ガイドを参照しながら簡単なアプリから始めるか、[サンプリアプリ](https://github.com/auth0-samples/auth0-ionic-samples)を複製してください。

      また、[Capacitorの開発ワークフロー](https://capacitorjs.com/docs/basics/workflow)を理解しておく必要もあります。
      </Section>

      <Section id={sections[1].id} title={sections[1].title} stepNumber="2">
      Auth0のサービスを利用するには、Auth0 Dashboadに設定済みのアプリケーションがある必要があります。Auth0アプリケーションは、プロジェクトに対してどのように認証が動作して欲しいかを構成する場所です。

      <Info>
      以下の説明では、「`YOUR_PACKAGE_ID`」を実際のアプリケーションのパッケージIDに置き換えてください。これは、`capacitor.config.ts`ファイルの`appId`フィールドで見つけて構成することができます。詳細については、[Capacitorの構成スキーマ](https://capacitorjs.com/docs/config#schema)を参照してください。
      </Info>

      ### アプリケーションを構成する

      対話型のセレクターを使ってAuth0アプリケーションを新規作成するか、統合したいプロジェクトを表す既存のアプリケーションを選択します。Auth0のすべてのアプリケーションには英数字からなる一意のクライアントIDが割り当てられており、アプリケーションのコードがSDKを通じてAuth0 APIを呼び出す際に使用されます。

      このクイックスタートを使って構成されたすべての設定は、[Dashboard](https://manage.auth0.com/#/)のアプリケーションを自動更新します。今後、アプリケーションの管理もDashboardで行えます。

      完了済みの構成を見てみたい場合は、サンプルアプリケーションをご覧ください。

      ### Callback URLを構成する

      Callback URLとは、Auth0がユーザーを認証後にリダイレクトするアプリケーション内URLです。設定されていない場合、ユーザーはログイン後にアプリケーションに戻りません。

      <Info>
      サンプルプロジェクトに沿って進めている場合には、次の値に設定します：

      `YOUR_PACKAGE_ID://{yourDomain}/capacitor/YOUR_PACKAGE_ID/callback`
      </Info>

      ### ログアウトURLを構成する

      ログアウトURLとは、Auth0がユーザーをログアウト後にリダイレクトするアプリケーション内URLです。設定されていない場合、ユーザーはアプリケーションからログアウトできず、エラーを受け取ります。

      <Info>
      サンプルプロジェクトに沿って進めている場合には、次の値に設定します：

      `YOUR_PACKAGE_ID://{yourDomain}/capacitor/YOUR_PACKAGE_ID/callback`
      </Info>

      ### 許可されているオリジンを構成する

      ネイティブアプリケーションからAuth0へ要求を送信できるようにするには、[アプリケーションの設定](https://manage.auth0.com/#/applications/%7ByourClientId%7D/settings)で次の**許可されているオリジン** を設定します。

      <Info>
      サンプルプロジェクトに沿って進めている場合、capacitorにiOSとAndroidでそれぞれ`capacitor://localhost, http://localhost`を設定します。
      </Info>

      最後に、アプリケーションの**［Application Type（アプリケーションタイプ）］** が**［Native（ネイティブ）］** になっていることを[アプリケーションの設定](https://manage.auth0.com/#/applications/%7ByourClientId%7D/settings)で必ず確認してください。
      </Section>

      <Section id={sections[2].id} title={sections[2].title} stepNumber="3">
      プロジェクトディレクトリで次のコマンドを実行して、Auth0 Angular SDKをインストールします：

      `npm install @auth0/auth0-angular`

      SDKはモジュールや認証サービスなど、Auth0をAngularアプリケーションに慣用的に統合しやすくする種類をいくつか公開しています。

      ### Capacitorプラグインをインストールする

      このクイックスタートとサンプルでは、Capacitorの公式プラグインをいくつか使用しています。次のコマンドを使用して、これらをアプリにインストールします：

      `npm install @capacitor/browser @capacitor/app`

      - [`@capacitor/browser`](https://capacitorjs.com/docs/apis/browser)：デバイスのシステムブラウザーと対話できるようになり、Auth0の認可エンドポイントへのURLを開くために使用されます。
      - [`@capacitor/app`](https://capacitorjs.com/docs/apis/app)：高レベルのアプリイベントを受け取れるようになるため、Auth0からのコールバックを扱うのに便利です。

      <Info>
      iOSのCapacitorのBrowserプラグインは[`SFSafariViewController`](https://developer.apple.com/documentation/safariservices/sfsafariviewcontroller)を使用し、iOS 11以降ではデバイス上のSafariとクッキーを共有しません。つまり、これらのデバイスではSSOが機能しません。SSOが必要な場合には、[ASWebAuthenticationSession](https://developer.apple.com/documentation/authenticationservices/aswebauthenticationsession)を使用する互換のプラグインを使用してください。
      </Info>
      </Section>

      <Section id={sections[3].id} title={sections[3].title} stepNumber="4">
      SDKは、SDKが機能するために必要なすべてのサービスを含んだ`AuthModule`をエクスポートします。このモジュールをアプリケーションに登録し、Auth0のドメインとクライアントIDで構成する必要があります。

      `AuthModule.forRoot`関数は以下の構成を使用します。

      - `domain`：Auth0 Dashboardで作成したアプリケーションの**設定** にある`domain`値、またはAuth0のカスタムドメイン機能を使用する場合のカスタムドメインです。
      - `clientId`：Auth0 Dashboardで作成したアプリケーションの**設定** にあるクライアントID値です。
      - `useRefreshTokens`：AndroidまたはiOSでauth0-angularをIonicと使用するには、リフレッシュトークンを有効にする必要があります。
      - `useRefreshTokensFallback`：AndroidまたはiOSでauth0-angularをIonicと使用するには、iframeのフォールバックを無効にする必要があります。
      - `authorizationParams.redirect_uri`：Auth0で認証した後に、ユーザーをリダイレクトするURLです。

      <Warning>
      アプリケーションの閉開後に認証を継続するには、SDKを構成する際に`cacheLocation`を`localstorage`に設定することをお勧めします。ただし、[localstorageにトークンを保管するリスク](/ja-jp/libraries/auth0-single-page-app-sdk#change-storage-options)を理解してください。また、状況によってはlocalstorageのデータが思いがけず復元される可能性もあるため、Capacitorアプリ内では**一次的** なものとして扱ってください。[Capacitorドキュメントに記載のストレージに関するガイド](https://capacitorjs.com/docs/guides/storage#why-cant-i-just-use-localstorage-or-indexeddb)をお読みください。

      さらに、より安全で永続的なストレージの仕組みが要件である場合、SDKを使用すると、[カスタムのキャッシュを実装](https://github.com/auth0/auth0-spa-js/blob/master/EXAMPLES.md#creating-a-custom-cache)してトークンを保管することができます。

      **注意** ：[CapacitorのStorageプラグイン](https://capacitorjs.com/docs/apis/storage)は、iOSでは[UserDefaults](https://developer.apple.com/documentation/foundation/userdefaults)、Androidでは[SharedPreferences](https://developer.android.com/reference/android/content/SharedPreferences)によってバックアップされるため、トークンの保管に使用**しない** ことをお勧めします。これらのAPIを使って保管されたデータは暗号化されません。セキュリティで保護されることもなく、クラウドと同期される可能性があります。
      </Warning>

      <Note>
      ##### チェックポイント
      アプリがAuth0 Angular SDKで構成されました。今度は、アプリケーションを実行して、SDKがエラーなく初期化されること、そして、以前と同じように動作することを確認します。
      </Note>
      </Section>

      <Section id={sections[4].id} title={sections[4].title} stepNumber="5">
      Capacitorアプリケーションでは、[CapacitorのBrowserプラグイン](https://capacitorjs.com/docs/apis/browser)によって、Auth0の[ユニバーサルログインページ](https://auth0.com/universal-login)にリダイレクトされます。`loginWithRedirect`関数の`openUrl`パラメーターに`Browser.open`の使用を設定し、デバイスのシステムブラウザーコンポーネント（iOSでは[SFSafariViewController](https://developer.apple.com/documentation/safariservices/sfsafariviewcontroller)、Androidでは[Chrome Custom Tabs](https://developer.chrome.com/docs/android/custom-tabs)）でURLが開くようにします。

      <Info>
      SDKの`loginWithRedirect`メソッドは、デフォルトで`window.location.href`を使用して、ユーザーのデバイスにあるデフォルトのブラウザーアプリケーションでログインページを開きます。プラットフォームに適切なシステムブラウザーコンポーネントは使用しません。ユーザーが認証でアプリケーションを離れるため、ユーザーエクスペリエンスとしては最適ではありません。
      </Info>

      <Note>
      ##### チェックポイント
      loginWithRedirect関数は、SDKにログインフローを開始するように指示します。openUrlパラメーターにログインURLを設定して、Browser.open関数を呼し出し、プラットフォームのシステムブラウザーコンポーネントでログインURLを開きます。これは、ユーザーがアプリケーションにログインする方法を提供します。ユーザーはAuth0のログインページにリダイレクトされ、エラーは一切受け取りません。
      </Note>
      </Section>

      <Section id={sections[5].id} title={sections[5].title} stepNumber="6">
      ユーザーがユニバーサルログインページでログインすると、カスタムURLスキームを使ったURLでアプリにリダイレクトされます。`appUrlOpen`イベントがアプリ内で処理されなければなりません。Auth0 SDKの`handleRedirectCallback`メソッドを呼び出すと、認証状態を初期化することができます。

      このメソッドは、Auth0からのリダイレクトでのみ使用することができます。正常に機能していることを確認するには、URL内の`code`と`state`パラメーターを確認します。

      このイベントが発生した際に、`Browser.close()`メソッドがブラウザーを閉じるようにします。

      `appUrlOpen`イベントのコールバックが`ngZone.run`でラップされていることに注意してください。`handleRedirectCallback`の実行時に発生するオブザーバブルへの変更は、Angularアプリが受け取ります。詳細については、「[AngularをCapacitorと使用する](https://capacitorjs.com/docs/guides/angular)」をお読みください。それ以外の場合では、画面がログイン後の認証状態で更新されません。

      <Info>
      以下の説明では、カスタムURLスキームを使用して、アプリケーション内でコールバックを処理することを前提にしています。このためには、`YOUR_PACKAGE_ID`を選択したプラットのURLスキームで置き換えて登録します。詳細については、iOSには「[カスタムURLスキームを定義する](https://developer.apple.com/documentation/xcode/defining-a-custom-url-scheme-for-your-app)」、Androidには「[アプリコンテンツ用のディープリンクを作成する](https://developer.android.com/training/app-links/deep-linking)」をお読みください。
      </Info>

      <Note>
      ##### チェックポイント
      アプリケーションのAppコンポーネントにappUrlOpenを追加して、ログインします。ユーザーが認証して、アプリにログインすると、ブラウザーのウィンドウが閉じます。
      </Note>
      </Section>

      <Section id={sections[6].id} title={sections[6].title} stepNumber="7">
      ユーザーがログインできるようになりました。今度は、ログアウトする方法を構成する必要があります。ユーザーをAuth0のログアウトエンドポイントにリダイレクトし、ブラウザー内のセッションをクリアする必要があります。他の場合と同様に、ユーザーがアプリから離れることでユーザーエクスペリエンスが損なわれないように、CapacitorのBrowserプラグインがリダイレクトを処理するようにします。

      Auth0 SDKを使用してIonicとCapacitorで実現するには、以下を行います。

      - アプリについて、ログアウト後にAuth0のリダイレクト先となるURLを構築します。これは、登録済みのカスタムスキームとAuth0ドメインを使ったURLです。これを、Auth0 Dashboardの**［Allowed Logout URLs（許可されているログアウトURL）］** の構成に追加します。
      - `logout`を呼び出し、`logoutParams.returnTo`パラメーターにリダイレクト先のURLを渡して、SDKからログアウトします。
      - CapacitorのBrowserプラグインを使用して`Browser.open`でURLを開くコールバックに、`openUrl`パラメーターを設定します。

      <Info>
      ログインの手順と同様に、`logout`を呼び出す際に`openUrl`を設定しないと、SDKがユーザーをログアウトURLにリダイレクトするのに、デバイスのデフォルトのブラウザーアプリケーションが使用されるため、ユーザーエクスペリエンスとしては最適ではありません。
      </Info>

      <Note>
      ##### チェックポイント
      ユーザーがアプリケーションからログアウトする方法を提供します。Auth0にリダイレクトしてから、returnToパラメーターで指定したアドレスへ移動することを確認します。ユーザーがアプリケーションにログインしていないことを確認します。
      </Note>
      </Section>

      <Section id={sections[7].id} title={sections[7].title} stepNumber="8">
      Auth0 SDKは必要な任意のコンポーネントについて、名前やプロフィール写真など、ログイン済みのユーザーに関連付けられたプロファイル情報を取得し、ユーザーインターフェイスをパーソナライズします。プロファイル情報は、`AuthService`が公開する`user$`プロパティを介して使用することができます。

      <Note>
      ##### チェックポイント
      ユーザーがアプリ内でユーザープロファイルの詳細を表示できる手段を提供し、ログインした後に自分のプロファイル情報を取得して画面に表示できることを確認します。
      </Note>
      </Section>

    ## 次のステップ

    成功です！ここまで来れば、アプリケーションにログイン、ログアウト、ユーザープロファイル情報が備わっているはずです。

    これでクイックスタートチュートリアルは終了ですが、機能はまだまだたくさんあります。Auth0でできることについて詳しくは、以下をご覧ください。

    *   [Auth0 Dashboard](https://manage.auth0.com/#) - Auth0のテナントやアプリケーションを構成して管理する方法について説明します
    *   [Auth0 Marketplace](https://marketplace.auth0.com/) - Auth0の機能性を拡張できる各種の統合を見つけられます
  </Content>

  <SideMenu sections={sections}>
      <SideMenuSectionItem id={sections[0].id}>
        <SignUpForm />
      </SideMenuSectionItem>

      <SideMenuSectionItem id={sections[1].id}>
        <SignUpForm />
      </SideMenuSectionItem>

      <SideMenuSectionItem id={sections[2].id}>
        <SignUpForm />
      </SideMenuSectionItem>

      <SideMenuSectionItem id={sections[3].id}>
        <CodeGroup>
          <AppModule/>
          <AppComponent/>
          <Loginbutton/>
          <Logoutbutton/>
          <Userprofile/>
        </CodeGroup>
      </SideMenuSectionItem>

      <SideMenuSectionItem id={sections[4].id}>
        <CodeGroup>
          <Loginbutton/>
          <AppModule/>
          <AppComponent/>
          <Logoutbutton/>
          <Userprofile/>
        </CodeGroup>
      </SideMenuSectionItem>

      <SideMenuSectionItem id={sections[5].id}>
        <CodeGroup>
          <AppComponent/>
          <AppModule/>
          <Loginbutton/>
          <Logoutbutton/>
          <Userprofile/>
        </CodeGroup>
      </SideMenuSectionItem>

      <SideMenuSectionItem id={sections[6].id}>
        <CodeGroup>
          <Logoutbutton/>
          <AppModule/>
          <AppComponent/>
          <Loginbutton/>
          <Userprofile/>
        </CodeGroup>
      </SideMenuSectionItem>

      <SideMenuSectionItem id={sections[7].id}>
        <CodeGroup>
          <Userprofile/>
          <AppModule/>
          <AppComponent/>
          <Loginbutton/>
          <Logoutbutton/>
        </CodeGroup>
      </SideMenuSectionItem>

    </SideMenu>
</Recipe>
