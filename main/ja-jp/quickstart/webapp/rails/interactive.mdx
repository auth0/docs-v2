---
title: "Ruby on Railsアプリケーションにログインを追加する"
permalink: "interactive"
'description': "このチュートリアルは、Ruby on Railsアプリケーションにユーザーログインを追加する方法について説明します。"
'og:title': "Ruby on Railsアプリケーションにログインを追加する"
'og:description': "このチュートリアルは、Ruby on Railsアプリケーションにユーザーログインを追加する方法について説明します。"
'og:image': "/docs/media/platforms/rails.png"
'twitter:title': "Ruby on Railsアプリケーションにログインを追加する"
'twitter:description': "このチュートリアルは、Ruby on Railsアプリケーションにユーザーログインを追加する方法について説明します。"
sidebarTitle: Ruby on Rails
mode: wide
---
import {AuthCodeBlock} from "/snippets/AuthCodeBlock.jsx";

import { Recipe, Content, Section, SideMenu, SideMenuSectionItem, SignUpForm } from "/snippets/recipe.jsx";
import { LoggedInForm } from "/snippets/Login.jsx";
import Auth0Yml from "/snippets/quickstart/webapp/rails/auth0.yml.mdx";
import Auth0 from "/snippets/quickstart/webapp/rails/auth0.rb.mdx";
import Auth0Controller from "/snippets/quickstart/webapp/rails/auth0_controller.rb.mdx";
import Routes from "/snippets/quickstart/webapp/rails/routes.rb.mdx";
import Secured from "/snippets/quickstart/webapp/rails/secured.rb.mdx";

export const sections = [
  { id: "auth0を構成する", title: "Auth0を構成する" },
  { id: "依存関係を追加する", title: "依存関係を追加する" },
  { id: "sdkを構成する", title: "SDKを構成する" },
  { id: "omniauthミドルウェアを構成する", title: "OmniAuthミドルウェアを構成する" },
  { id: "auth0コントローラーを追加する", title: "Auth0コントローラーを追加する" },
  { id: "ルートを構成する", title: "ルートを構成する" },
  { id: "アプリケーションにログインを追加する", title: "アプリケーションにログインを追加する" },
  { id: "アプリケーションにログアウトを追加する", title: "アプリケーションにログアウトを追加する" },
  { id: "ユーザープロファイル情報を表示する", title: "ユーザープロファイル情報を表示する" }
]

<Recipe>
  <Content>
    <Section id={sections[0].id} title={sections[0].title} stepNumber="1">
      Auth0のサービスを利用するには、Auth0 Dashboadに設定済みのアプリケーションがある必要があります。Auth0アプリケーションは、開発中のプロジェクトに対してどのように認証が動作して欲しいかを構成する場所です。

      ### アプリケーションを構成する

      対話型のセレクターを使ってAuth0アプリケーションを新規作成するか、統合したいプロジェクトを表す既存のアプリケーションを選択します。Auth0のすべてのアプリケーションには英数字からなる一意のクライアントIDが割り当てられており、アプリケーションのコードがSDKを通じてAuth0
            APIを呼び出す際に使用されます。

      このクイックスタートを使って構成されたすべての設定は、[Dashboard](https://manage.auth0.com/#/)のアプリケーションを自動更新します。今後、アプリケーションの管理もDashboardで行えます。

      完了済みの構成を見てみたい場合は、サンプルアプリケーションをご覧ください。

      ### Callback URLを構成する

      Callback URLとは、Auth0がユーザーを認証後にリダイレクトするアプリケーション内URLです。設定されていない場合、ユーザーはログイン後にアプリケーションに戻りません。

      <Info>
      サンプルプロジェクトに沿って進めている場合は、`http://localhost:3000/auth/auth0/callback`に設定してください。
      </Info>

      ### ログアウトURLを構成する

      ログアウトURLとは、Auth0がユーザーをログアウト後にリダイレクトするアプリケーション内URLです。設定されていない場合、ユーザーはアプリケーションからログアウトできず、エラーを受け取ります。

      <Info>
      サンプルプロジェクトに沿って進めている場合は、`http://localhost:3000`に設定してください。
      </Info>

      ### Allowed Web Origins（許可されているWebオリジン）を構成する

      Allowed Web
            Origin（許可されているWebオリジン）とは、認証フローへのアクセスを許可されるURLです。これにはプロジェクトのURLが含まれている必要があります。適切に設定されていない場合、プロジェクトが認証トークンを暗黙でリフレッシュできず、ユーザーがアプリケーションを再び訪問した時、またはページを再読み込みした時にログアウトした状態になってしまいます。

      <Info>
      サンプルプロジェクトに沿って進めている場合は、`http://localhost:3000`に設定してください。
      </Info>
    </Section>

    <Section id={sections[1].id} title={sections[1].title} stepNumber="2">
      認証フローをハンドリングするには、カスタム[OmniAuthストラテジー](https://github.com/intridea/omniauth#omniauth-standardized-multi-provider-authentication)である`omniauth-auth0`を使います。

      `Gemfile`に次の依存関係を追加します：

      <AuthCodeBlock icon="file-code" language="gem" lines="true">
      AUTH0_SECRET='use [openssl rand -hex 32] to generate a 32 bytes value'
      APP_BASE_URL='http://localhost:3000'
      AUTH0_DOMAIN='https://{USER_DOMAIN}'
      AUTH0_CLIENT_ID='{USER_CLIENT_ID}'
      AUTH0_CLIENT_SECRET='{USER_CLIENT_SECRET}'
      </AuthCodeBlock>

      gemが追加されたら、`bundle install`でインストールします。
    </Section>

    <Section id={sections[2].id} title={sections[2].title} stepNumber="3">
      構成ファイル`./config/auth0.yml`を作成して、Auth0
            Dashboardにあるアプリケーションの**［Settings（設定）］** で確認できるAuth0ドメイン、クライアントID、クライアントシークレットの値を指定します。
    </Section>

    <Section id={sections[3].id} title={sections[3].title} stepNumber="4">
      `./config/initializers/auth0.rb`という以下のイニシャライザーファイルを作成し、前の手順で作成した構成ファイルで**OmniAuth** ミドルウェアを[構成](https://github.com/auth0/omniauth-auth0/blob/master/EXAMPLES.md#send-additional-authentication-parameters)します。

      `callback_path`がAuth0アプリケーションの［Allowed Callback URLs（許可されているコールバックURL）］にある値と一致することを確認します。
    </Section>

    <Section id={sections[4].id} title={sections[4].title} stepNumber="5">
      ログアウトURLを構築するために、認証コールバック、`logout`アクション、メソッドをハンドリングするAuth0コントローラーを作成します。

      次のコマンドを実行します：`rails generate controller auth0 callback failure logout --skip-assets --skip-helper --skip-routes --skip-template-engine`。

      コールバックメソッドの内部で、（`request.env['omniauth.auth']`として返された）ユーザー情報のハッシュをアクティブセッションに割り当てます。

      ログアウトを構築するため、`logout`アクションの内部で`reset_session`メソッドを呼び出し、セッション内に保存されたオブジェクトをすべて消去します。それから、Auth0ログアウトエンドポイントにリダイレクトします。`reset_session`についての詳細は、[「Ruby on Rails ActionController」ドキュメント](http://api.rubyonrails.org/classes/ActionController/Base.html#M000668)をご覧ください。
    </Section>

    <Section id={sections[5].id} title={sections[5].title} stepNumber="6">
      これらのルートを`./config/routes.rb`ファイルに追加します。

      ルートは所定の位置になければなりません。これにより、RailsはさまざまなAuth0 Callback URLを前の手順で作成したAuth0コントローラーにルートする方法を認識します。

      <Note>
      ##### チェックポイント

      アプリケーションを実行して、意図通りに動作し続け、Auth0に関連したエラーを受け取らないことを確認します。
      </Note>
    </Section>

    <Section id={sections[6].id} title={sections[6].title} stepNumber="7">
      ユーザーが`/auth/auth0`エンドポイントを訪れると、アプリケーションにログインできるようになりました。

      <Info>
      [偽の認証要求を防ぐ](https://github.com/cookpad/omniauth-rails_csrf_protection)ためには、`link_to`または`button_to`ヘルパーメソッドを`:post`メソッドと一緒に使います。
      </Info>

      <AuthCodeBlock icon="file-code" language="ruby" lines="true">
      AUTH0_SECRET='use [openssl rand -hex 32] to generate a 32 bytes value'
      APP_BASE_URL='http://localhost:3000'
      AUTH0_DOMAIN='https://{USER_DOMAIN}'
      AUTH0_CLIENT_ID='{USER_CLIENT_ID}'
      AUTH0_CLIENT_SECRET='{USER_CLIENT_SECRET}'
      </AuthCodeBlock>

      <Note>
      ##### チェックポイント

      選択されるとユーザーを`/auth/auth0`エンドポイントにリダイレクトするボタンを、アプリケーションに追加します。ログインのためAuth0にリダイレクトされ、認証に成功するとアプリに戻されることを確認してください。
      </Note>
    </Section>

    <Section id={sections[7].id} title={sections[7].title} stepNumber="8">
      Railsアプリケーションにログインできるようになったら、ログアウトする方法が必要です。ユーザーを`auth/logout`アクションにリダイレクトしてログアウトさせると、ユーザーはAuth0ログアウトエンドポイントへリダイレクトされます。

      <Info>
      前の手順の後にこの手順をテストするには、セッションを消去して、ユーザーをAuth0ログアウトエンドポイントへリダイレクトしなければならない可能性があります。
      </Info>

      <AuthCodeBlock icon="file-code" language="ruby" lines="true">
      AUTH0_SECRET='use [openssl rand -hex 32] to generate a 32 bytes value'
      APP_BASE_URL='http://localhost:3000'
      AUTH0_DOMAIN='https://{USER_DOMAIN}'
      AUTH0_CLIENT_ID='{USER_CLIENT_ID}'
      AUTH0_CLIENT_SECRET='{USER_CLIENT_SECRET}'
      </AuthCodeBlock>

      <Note>
      ##### チェックポイント

      選択されるとユーザーを`/auth/logout`エンドポイントにリダイレクトするボタンを、アプリケーションに追加します。Auth0にリダイレクトされた後即座にアプリケーションに戻り、ログインした状態ではないことを確認します。
      </Note>
    </Section>

    <Section id={sections[8].id} title={sections[8].title} stepNumber="9">
      ユーザーのプロファイルを表示するには、アプリケーションに保護されたルートがなければなりません。ルートへのアクセスは[Concern](https://guides.rubyonrails.org/getting_started.html#using-concerns)で管理でき、複数のコントローラーで共有できます。Concernはユーザーが認証されていない場合、自動的にAuth0にリダイレクトしなければなりません。そうでない場合は、Concernは現在のユーザープロファイルを返します。

      Concernができたら、ログインユーザーを必要とするすべてのコントローラーに含めます。その後、次の例のように、`session[:userinfo]`セッションからユーザーにアクセスできます：

      <AuthCodeBlock icon="file-code" language="ruby" lines="true">
      AUTH0_SECRET='use [openssl rand -hex 32] to generate a 32 bytes value'
      APP_BASE_URL='http://localhost:3000'
      AUTH0_DOMAIN='https://{USER_DOMAIN}'
      AUTH0_CLIENT_ID='{USER_CLIENT_ID}'
      AUTH0_CLIENT_SECRET='{USER_CLIENT_SECRET}'
      </AuthCodeBlock>

      ユーザーがセッションから読み込まれたら、フロントエンドで情報を表示するために使います：

      <AuthCodeBlock icon="file-code" language="html" lines="true">
      AUTH0_SECRET='use [openssl rand -hex 32] to generate a 32 bytes value'
      APP_BASE_URL='http://localhost:3000'
      AUTH0_DOMAIN='https://{USER_DOMAIN}'
      AUTH0_CLIENT_ID='{USER_CLIENT_ID}'
      AUTH0_CLIENT_SECRET='{USER_CLIENT_SECRET}'
      </AuthCodeBlock>

      <Note>
      ##### チェックポイント

      `Secured` concernをアプリに追加してから、認証されたユーザーがアクセスするために必要なコントローラーに含めます。
                    認証されたユーザーがこのコントローラー内でアクションにアクセスでき、認証されていないユーザーは認証のためにAuth0にリダイレクトされることを確認します。
      </Note>
    </Section>

    ## 次のステップ

    成功です！ここまで来れば、アプリケーションにログイン、ログアウト、ユーザープロファイル情報が備わっているはずです。

    これでクイックスタートチュートリアルは終了ですが、機能はまだまだたくさんあります。Auth0でできることについて詳しくは、以下をご覧ください。

    *   [Auth0 Dashboard](https://manage.auth0.com/#) - Auth0のテナントやアプリケーションを構成して管理する方法について説明します
    *   [omniauth-auth0 SDK](https://github.com/auth0/omniauth-auth0) - このチュートリアルで使用されているSDKをより詳しく説明します
    *   [Auth0 Marketplace](https://marketplace.auth0.com/) - Auth0の機能性を拡張できる各種の統合を見つけられます
  </Content>

  <SideMenu sections={sections}>
    <SideMenuSectionItem id={sections[0].id}>
      <SignUpForm />
    </SideMenuSectionItem>

    <SideMenuSectionItem id={sections[1].id}>
      <SignUpForm />
    </SideMenuSectionItem>

    <SideMenuSectionItem id={sections[2].id}>
      <CodeGroup>
        <Auth0Yml/>
        <Auth0/>
        <Auth0Controller/>
        <Routes/>
        <Secured/>
      </CodeGroup>
    </SideMenuSectionItem>

    <SideMenuSectionItem id={sections[3].id}>
      <CodeGroup>
        <Auth0/>
        <Auth0Yml/>
        <Auth0Controller/>
        <Routes/>
        <Secured/>
      </CodeGroup>
    </SideMenuSectionItem>

    <SideMenuSectionItem id={sections[4].id}>
      <CodeGroup>
        <Auth0Controller/>
        <Auth0Yml/>
        <Auth0/>
        <Routes/>
        <Secured/>
      </CodeGroup>
    </SideMenuSectionItem>

    <SideMenuSectionItem id={sections[5].id}>
      <CodeGroup>
        <Routes/>
        <Auth0Yml/>
        <Auth0/>
        <Auth0Controller/>
        <Secured/>
      </CodeGroup>
    </SideMenuSectionItem>

    <SideMenuSectionItem id={sections[6].id}>
      <SignUpForm />
    </SideMenuSectionItem>

    <SideMenuSectionItem id={sections[7].id}>
      <SignUpForm />
    </SideMenuSectionItem>

    <SideMenuSectionItem id={sections[8].id}>
      <CodeGroup>
        <Secured/>
        <Auth0Yml/>
        <Auth0/>
        <Auth0Controller/>
        <Routes/>
      </CodeGroup>
    </SideMenuSectionItem>

  </SideMenu>
</Recipe>
