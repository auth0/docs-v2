---
title: "Auth0 Android v2の移行ガイド"
permalink: "auth0-android-v2-migration-guide"
'description': "Aut0 Android v1アプリをSDKのバージョン2に移行する方法について説明します。"
'og:title': "Auth0 Android v2の移行ガイド"
'og:description': "Aut0 Android v1アプリをSDKのバージョン2に移行する方法について説明します。"
'og:image': "https://cdn2.auth0.com/docs/1.14567.0/img/share-image.png"
'twitter:title': "Auth0 Android v2の移行ガイド"
'twitter:description': "Aut0 Android v1アプリをSDKのバージョン2に移行する方法について説明します。"
---

Auth0 Android SDKバージョン2には、Auth0をAndroidアプリに統合するための改善が数多く含まれています。**このアップグレードには互換性のない変更が含まれています。** v2に移行する際には、このガイドを読んで、変更内容を理解してください。

## 要件の変更

v2にはAndroid APIバージョン21以降とJava 8以降が必要です。

AndroidとKotlinの各プラグインでJava 8のバイトコードをターゲットにするために、`build.gradle`には以下が必要です。

``` lines
android {
  compileOptions {
      sourceCompatibility JavaVersion.VERSION_1_8
      targetCompatibility JavaVersion.VERSION_1_8
  }

  kotlinOptions {
      jvmTarget = '1.8'
  }
}
```

## Open ID Connect限定

v2はOIDC準拠のアプリケーションにのみ対応しています。このSDKでユーザーを認証する際には、Auth0が現在提供している認証パイプラインとエンドポイントだけが使用されます。`setOIDCConformant(boolean value)`メソッドは`Auth0`クラスから削除されました。

詳細については、「[OpenID Connectプロトコル](https://auth0.com/docs/protocols/openid-connect-protocol)」を参照してください。

## PKCEを使用した認可コード

v2は[Proof Key for Code Exchange（PKCE）を使用した認可コード](https://auth0.com/docs/flows/authorization-code-flow-with-proof-key-for-code-exchange-pkce)フローに対応しています。`WebAuthProvider.Builder`の`withResponseType(@ResponseType int type)`メソッドは削除されました。

## WebView対応の削除

`WebView`コンポーネントを使用した非推奨の認証機能が削除されました。これに代わり、セキュリティとユーザーの信頼を強化するため、外部のブラウザーアプリケーションが必ず使用されます。

## レガシー認証API対応の削除

レガシーとして分類された[認証API](https://auth0.com/docs/api/authentication)を呼び出すメソッドとクラスが削除されました。完全なリストについては、以下の「**削除されたクラスおよびインターフェイス** 」セクションを参照してください。

## 要求インターフェイスの変更

`com.auth0.android.request`パッケージは、HTTP要求の構築と実行に使用する最上レベルのインターフェイスを定義します。これまでに報告されてきた問題は、すべての要求タイプにカスタムヘッダーと要求パラメーターを追加できないことでした。それが、要求インターフェイスをリファクタリングして、あらゆる要求が追加のヘッダーと要求パラメーターでカスタマイズできるようになりました。今後、これらのパラメーターは`String`タイプでなければなりません。

最上レベルの`Request`インターフェイスは以下のメソッドを指定します。

* `public fun addParameters(parameters: Map<String, String>): Request<T, U>`
* `public fun addParameter(name: String, value: String): Request<T, U>`
* `public fun addHeader(name: String, value: String): Request<T, U>`

以下のインターフェイスは削除されました。

* `ParameterizableRequest`
* `AuthRequest`

`AuthenticationAPIClient`には、結果となるメソッドの戻り値のタイプについて数多くの変更があります。たとえば：

* `ParameterizableRequest`や`TokenRequest`、`DatabaseConnectionRequest`を返すメソッドはすべて、`Request`を返すように変更されました。

* `AuthRequest`を返すメソッドはすべて、`AuthenticationRequest`を返すように変更されました。

これらのメソッドの戻り値のタイプを直接使用している場合には、上記のタイプが予期されるようにコードを変更する必要があります。要求を行うのに`start`や`execute`を連鎖的に呼び出している場合には、変更する必要はありません。

`AuthenticationRequest`インターフェイスに`setAccessToken("{ACCESS-TOKEN}")`メソッドがなくなりました。このメソッドは、Authentication APIのレガシー[/oauth/access_token](https://auth0.com/docs/api/authentication#social-with-provider-s-access-token)エンドポイントへの要求にトークンを設定するためのものでしたが、2017年6月に無効化されています。この名前でパラメーターを送信しなければならない場合には、`addParameter("access_token", "{ACCESS-TOKEN}")`を使用してください。

`ParameterizableRequest`または`AuthRequest`を実装していたクラスはすべて、これらの変更に対応するべく更新されています。

完全なリストについては、以下の「**削除されたクラスおよびインターフェイス** 」セクションを参照してください。

## ネットワーククライアントのカスタマイズ

v2では、このライブラリーのHTTP要求を行う方法がさらにカスタマイズできるようになりました。新しいインターフェイスである`NetworkingClient`は、HTTP要求の実行にコントラクトを定義します。`Auth0`クラスは`NetworkingClient`のインスタンスで構成することができます。これにより、独自の実装でネットワーククライアントが完全に制御できるようになります。また、このライブラリーが提供するデフォルトのネットワーククライアントは、いくつかのサンプルのカスタマイズポイントに対応して、一般的なカスタマイズポイントを構成しやすくしています。

### タイムアウト構成

```kotlin lines
// Before
val account = Auth0("{YOUR_CLIENT_ID}", "{YOUR_DOMAIN}")

account.connectTimeoutInSeconds = 30
account.readTimeoutInSeconds = 30

val authAPI = AuthenticationAPIClient(account)

// After
val netClient = DefaultClient(
    connectTimeout = 30,
    readTimeout = 30
)

val account = Auth0("{YOUR_CLIENT_ID}", "{YOUR_DOMAIN}")
account.networkingClient = netClient
```

### ロギング構成

```kotlin lines
// Before
val account = Auth0("{YOUR_CLIENT_ID}", "{YOUR_DOMAIN}")
account.isLoggingEnabled = true

val authAPI = AuthenticationAPIClent(account)

// After
val netClient = DefaultClient(
    enableLogging = true
)

val account = Auth0("{YOUR_CLIENT_ID}", "{YOUR_DOMAIN}")
account.networkingClient = netClient
```

## 変更内容の詳細

### パッケージを変更したファイル

* `com.auth0.android.authentication.request.ProfileRequest`クラスが`com.auth0.android.request.ProfileRequest`に移動されました。
* `com.auth0.android.authentication.request.SignUpRequest`クラスが`com.auth0.android.request.SignUpRequest`に移動されました。

### 内部パッケージ

このライブラリーは、以前のバージョンでは`com.auth0.android.request.internal`パッケージのクラスがいくつか公開されていました。それらはライブラリーで意図的に公開APIの一部であったわけではなく、Javaのドキュメントでも直接的な使用は推奨されていません。コードベースがKotlinに移行するにあたって、`internal`修飾子を必要な場所で活用することになりました。これらのクラスは、Javaプロジェクトの`public`クラスとして表示されるかもしれませんが、使用は控えてください。今のところ、このライブラリーの公開APIの一部ではありません。

これらのクラスについて、サポートは提供していません。必要であれば、予告なく変更されます。

### 削除されたクラスおよびインターフェイス

* `com.auth0.android.util.Base64`クラスは削除されました。`android.util.Base64`を使用してください。
* `com.auth0.android.request.ParameterizableRequest`インターフェイスは削除されました。要求のヘッダーとパラメーターを追加する機能は`com.auth0.android.request.Request`インターフェイスに移動されました。
* `com.auth0.android.request.AuthRequest`インターフェイスは削除されました。`com.auth0.android.request.AuthenticationRequest`インターフェイスを使用してください。
* `com.auth0.android.provider.WebAuthActivity`クラスは削除されました。認証には常に外部のブラウザーアプリケーションが使用されます。
* `com.auth0.android.result.Delegation`クラスは削除されました。これは、Authentication APIのレガシーエンドポイントに対する要求の結果として使用されていましたが、2017年6月に無効化されています。
* `com.auth0.android.authentication.request.DelegationRequest`クラスは削除されました。これは、レガシーのAuthentication APIエンドポイントに対する要求を表すのに使用されていましたが、2017年6月に無効化されています。
* `com.auth0.android.util.Telemetry`クラスは名前が`com.auth0.android.util.Auth0UserAgent`に変更されました。
* `com.auth0.android.request.AuthorizableRequest`クラスは削除されました。同じ結果は`addHeader("Authorization", "Bearer {TOKEN_VALUE}")`を使用して得ることができます。
* `com.auth0.android.authentication.request.TokenRequest`クラスは削除されました。コード検証と、要求のあらゆるヘッダーとパラメーターを設定する機能は、`com.auth0.android.request.Request`インターフェイスに移動されました。
* `com.auth0.android.authentication.request.DatabaseConnectionRequest`クラスは削除されました。要求のあらゆるヘッダーとパラメーターを設定する機能は、`com.auth0.android.request.Request`インターフェイスに移動されました。
* `com.auth0.android.provider.VoidCallback`クラスは削除されました。引数を受け付けないコールバックを使用する機能は、`Callback<Void, AuthenticationException>`に置き換えられました。
* `com.auth0.android.request.ErrorBuilder`インターフェイスは削除されました。
* `com.auth0.android.RequestBodyBuildException`クラスは削除されました。
* `com.auth0.android.util.CheckHelper`クラスは削除されました。
* `com.auth0.android.util.JsonRequired`インターフェイスは削除されました。
* `com.auth0.android.util.JsonRequiredTypeAdapterFactory`クラスは削除されました。

### 削除された定数

* `ParameterBuilder.GRANT_TYPE_JWT`は削除されました。
* `ParameterBuilder.ID_TOKEN_KEY`は削除されました。
* `ParameterBuilder.DEVICE_KEY`は削除されました。
* `ParameterBuilder.ACCESS_TOKEN_KEY`は削除されました。
* `ResponseType.CODE`、`ResponseType.ID_TOKEN`、および`ResponseType.ACCESS_TOKEN`は削除されました。

### 変更されたクラスおよびインターフェイス

* 今後は`SignupRequest`が`AuthenticationRequest`を実装します。`AuthRequest`は削除されました。
* 今後は`AuthorizableRequest`が`Request`を拡張します。`ParameterizableRequest`は削除されました。
* `BaseCallback`は廃止されました。`Callback`を使用してください。

### 変更されたコンストラクター

* `AuthenticationAPIClient`は`Context`から構築できなくなりました。`AuthenticationAPIClient(auth0:Auth0)`を使用してください。`Auth0`のインスタンスは`Context`を使って作成できます。
* `UsersAPIClient`は`Context`から構築できなくなりました。`UsersAPIClient(auth0:Auth0, token:String)`を使用してください。`Auth0`のインスタンスは`Context`を使って作成できます。
* 今後、`SignupRequest`には第二パラメーターに`AuthenticationRequest`が必要になります。
* 今後、`ProfileRequest`には`AuthenticationRequest`と`Request<UserProfile, AuthenticationException>`が必要になります。
* `Credentials`が「expires in」値で構築できなくなりました。使用期限日または「expires at」値を指定してください。通常、`Credentials`を独自に構築することはありません。

### 削除または変更されたメソッド

#### 削除されたAuth0のメソッド

* `setOIDCConformant(boolean enabled)`と`isOIDCConformant()`は削除されました。SDKは現在OIDC準拠のアプリケーションにのみ対応しています。
* `doNotSendTelemetry()`は削除されました。取って代わるものはありません。
* `setWriteTimeoutInSeconds(seconds)`と`getWriteTimeoutInSeconds(seconds)`は削除されました。取って代わるものはありません。
* `setReadTimeoutInSeconds(seconds)`と`getReadTimeoutInSeconds(seconds)`は削除されました。読み出しタイムアウトは`DefaultClient`クラスで直接カスタマイズできます。`DefaultClient(readTimeout = 123)`を使用してください。
* `setConnectTimeoutInSeconds(seconds)`と`getConnectTimeoutInSeconds(seconds)`は削除されました。接続タイムアウトは`DefaultClient`クラスで直接カスタマイズできます。`DefaultClient(connectTimeout = 123)`を使用してください。
* `setLoggingEnabled(boolean enabled)`と`isLoggingEnabled()`は削除されました。ネットワークトラフィックロガーは`DefaultClient`クラスで直接有効化できます。`DefaultClient(enableLogging = true)`を使用してください。デバッグのために使用し、決して運用環境で有効化してはいけません。
* `setTLS12Enforced()`と`isTLS12Enforced()`は削除されました。現在、SDKはデフォルトでmodern TLSに対応します。

#### 削除または変更されたAuthenticationAPIClientのメソッド

* `setUserAgent(String)`は削除されました。ヘッダーは、`addHeader("{NAME}", "{VALUE}")`メソッドを使ってそれぞれの要求インスタンスで直接送信するか、`DefaultClient(defaultHeaders = mapOf())`コンストラクターパラメーターを通して、ネットワーククライアントのインスタンスにグローバルに送信するように設定できます。

レガシーとして分類された[Authentication API](https://auth0.com/docs/api/authentication)を呼び出すためのメソッドとクラスは、v2で削除されました。以下のメソッドが削除されています。

* `delegation()`、`delegationWithIdToken("{ID-TOKEN}")`、`delegationWithRefreshToken("{REFRESH-TOKEN}")`、および`delegationWithIdToken("{ID-TOKEN}", "{API-TYPE}}")`。レガシーのAuthentication APIエンドポイントへの対応は削除されました。
* `loginWithOAuthAccessToken("{TOKEN}", {CONNECTION})`。選択されたソーシャルプロバイダーについては、`loginWithNativeSocialToken("{TOKEN}", "{TOKEN-TYPE}")`を使用できます。
* `tokenInfo("{ID-TOKEN}")`。`userInfo("{ACCESS-TOKEN}")`を使用してください。

`ParameterizableRequest`を返していた以下のメソッドは、`Request`を返すようになりました。

* `userInfo("{ACCESS-TOKEN}")`
* `revokeToken("{REFRESH-TOKEN}")`
* `renewAuth("{REFRESH-TOKEN}")`
* `passwordlessWithEmail("{EMAIL}", PasswordlessType, "{CONNECTION}")`
* `passwordlessWithSMS("{PHONE-NUNBER}", PasswordlessType, "{CONNECTION}")`
* `fetchJsonWebKeys()`

`AuthRequest`を返していた以下のメソッドは、`AuthenticationRequest`を返すようになりました。

* `login("{USERNAME-OR-EMAIL}", "{PASSWORD}", "{REALM-OR-CONNECTION}")`
* `login("{USERNAME-OR-EMAIL}", "{PASSWORD}")`
* `loginWithOTP("{MFA-TOKEN}", "{OTP}")`
* `loginWithNativeSocialToken("{TOKEN}", "{TOKEN-TYPE}")`
* `loginWithPhoneNumber("{PHONE-NUMBER}", "{VERIFICATION-CODE}", "{REALM-OR-CONNECTION}")`
* `loginWithEmail("{EMAIL}", "{VERIFICATION-CODE}", "{REALM-OR-CONNECTION}")`

`DatabaseConnectionRequest`を返していた以下のメソッドは、`Request`を返すようになりました。

* `createUser("{EMAIL}", "{PASSWORD}", "{USERNAME}", "{CONNECTION}")`
* `resetPassword("{EMAIL}","{CONNECTION}")`

`TokenRequest`を返していた以下のメソッドは、`Request`を返すようになりました。

* `token("{AUTHORIZATION-CODE}", "{CODE-VERIFIER}", "{REDIRECT-URI}")`

#### 削除されたAuthenticationRequestのメソッド

* `addAuthenticationParameters(parameters)`は削除されました。`addParameters(parameters)`を使用してください。
* `setDevice("{DEVICE}")`。`addParameter("device", "{VALUE}")`を使用してください。

#### 削除されたWebAuthProvider.Builderのメソッド

* `useCodeGrant(boolean useCodeGrant)`。取って代わるものはありません。v2はPKCEを使用したコードフローにのみ対応します。
* `useBrowser(boolean useBrowser)`。取って代わるものはありません。このライブラリーはWebView認証に非対応になりました。
* `useFullscreen(boolean useFullscreen)`。取って代わるものはありません。このライブラリーはWebView認証に非対応になりました。
* `withResponseType(@ResponseType int type)`。取って代わるものはありません。v2はPKCEを使用したコードフローにのみ対応します。
* `start(activity: Activity, callback: AuthCallback, requestCode: Int)`は削除されました。`start(activity: Activity, callback: Callback<Credentials, AuthenticationException>)`を使用してください。

#### 削除されたWebAuthProvider.LogoutBuilderのメソッド

* `start(context: Context, callback: VoidCallback)`。`start(context: Context, callback: Callback<Void, AuthenticationException>)`を使用してください。

#### 削除されたWebAuthProviderのメソッド

* `init(account: Auth0)`は削除されました。`login(account: Auth0)`を使用してください。
* `init(context: Context)`は削除されました。`login(account: Auth0)`を使用してください。
* `resume(requestCode: Int, resultCode: Int, intent: Intent)`は削除されました。`resume(intent: Intent)`を使用してください。
* `init(account: Auth0)`は削除されました。`login(account: Auth0)`を使用してください。

#### 削除されたParameterBuilderのメソッド

* `setDevice("{DEVICE}")`は削除されました。`set("device", "{VALUE}")`を使用してください。

#### 変更されたUsersAPIClientのメソッド

* `setUserAgent(String)`は削除されました。ヘッダーは、`addHeader("{NAME}", "{VALUE}")`メソッドを使ってそれぞれの要求インスタンスで直接送信するか、`DefaultClient(defaultHeaders = mapOf())`コンストラクターパラメーターを通して、ネットワーククライアントのインスタンスにグローバルに送信するように設定できます。

`ParameterizableRequest`を返していた以下のメソッドは、`Request`を返すようになりました。

* `link("{PRIMARY-USER-ID}", "{SECONDARY-TOKEN}")`
* `unlink("{PRIMARY-USER-ID}", "{SECONDARY-USER-ID}", "{SECONDARY-PROVIDER}")`
* `updateMetadata("{USER-ID}", userMetadata)`
* `getProfile("{USER-ID}")`

#### 削除または変更されたRequestFactoryのメソッド

`RequestFactory`クラスには、JSON要求本文や応答のシリアル化やシリアル化解除など、HTTP要求を容易にするメソッドが含まれています。`com.auth0.android.request.internal`パッケージの一部として、公開での使用は意図されていませんが、公開タイプとしては以下のように変更されています。

* すべての要求メソッドは、特定のHTTP要求ライブラリー（`OkHttp`など）から分離されるようにリファクタリングされています。
* すべての要求メソッドが`Request`を返すようになりました。
* すべての要求メソッドが小文字になりました（`POST()` -> `post()`など）。
* `authenticationPOST`メソッドは代替を提供することなく削除されました。これは、すべての`Request`インスタンスが必要に応じて、ヘッダーを使ってパラメーター化できるためです。

#### 変更されたProfileRequestのメソッド

* 今後、`addParameters`メソッドには値として、文字列からオブジェクトへのマッピングではなく、文字列から文字列へのマッピング（`addParameters(mapOf("key" to "val"))`）が必要です。

#### 変更されたSignUpRequestのメソッド

今後、パラメーターを設定するメソッドには値として、文字列からオブジェクトへのマッピングではなく、文字列から文字列へのマッピングが必要です。

* `addAuthenticationParameters(mapOf("key" to "val"))`
* `addSignupParameters(mapOf("key" to "val"))`
* `addParameters(mapOf("key" to "val"))`

また、`setDevice("device")`も削除されました。`addParameter("device", "{VALUE}")`を使用してください。