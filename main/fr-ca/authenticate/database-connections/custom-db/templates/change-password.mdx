---
title: "Modifier les modèles de script de mot de passe"
permalink: "change-password"
'description': "Décrit les modèles de scripts d’action de base de données personnalisés permettant de modifier le mot de passe d’un utilisateur."
'og:title': "Modifier les modèles de script de mot de passe"
'og:description': "Décrit les modèles de scripts d’action de base de données personnalisés permettant de modifier le mot de passe d’un utilisateur."
'og:image': "https://cdn2.auth0.com/docs/1.14567.0/img/share-image.png"
'twitter:title': "Modifier les modèles de script de mot de passe"
'twitter:description': "Décrit les modèles de scripts d’action de base de données personnalisés permettant de modifier le mot de passe d’un utilisateur."
---

Le script de modification du mot de passe met en œuvre la fonction définie pour modifier le mot de passe de l’utilisateur indiqué dans la base de données externe. Nous recommandons de nommer cette fonction `changePassword`.

Le script n’est utilisé que dans un [scénario d’authentification héritée](/docs/fr-ca/authenticate/database-connections/custom-db/overview-custom-db-connections) et est nécessaire si vous souhaitez modifier le mot de passe d’un utilisateur dans la base de données externe. Il s’exécutera lorsqu’un utilisateur effectue un [flux de production de réinitialisation de mot de passe](/docs/fr-ca/customize/login-pages/classic-login/customize-password-reset-page), ou lorsqu’un flux de production de modification de mot de passe est lancé depuis Auth0 Dashboard ou Auth0 Management API.

## Fonctionnalité ChangePassword

La fonctionnalité `changePassword` doit :

* Mettre à jour le mot de passe de l’utilisateur dans la base de données externe.
* Renvoyer `true` (ou un objet contenant la propriété `last_password_reset`) si l’opération de changement de mot de passe a réussi. Si la propriété `last_password_reset` est présente dans l’objet, elle sera mise à jour sur le profil de l’utilisateur.
* Renvoyer `false` si l’opération de changement de mot de passe a échoué.
* Renvoyer une erreur si la base de données externe n’a pas pu être atteinte.

### Définition

La fonction `changePassword` accepte trois paramètres et renvoie une fonction `callback` :

```javascript lines
changePassword(email, newPassword, callback): function
```

<table class="table"><thead>
<tr>
<th><strong>Paramètre</strong></th>
<th><strong>Type</strong></th>
<th><strong>Description</strong></th>
</tr>
</thead>
<tbody>
<tr>
<td>`email`</td>
<td>Chaîne</td>
<td>Adresse courriel de l’utilisateur dans Auth0 et dans la base de données externe.</td>
</tr>
<tr>
<td>`newPassword`</td>
<td>Chaîne</td>
<td>Valeur à définir comme nouveau mot de passe de l’utilisateur dans la base de données externe. Cette valeur est envoyée en clair à la fonction et <a href="#Encryption">doit être cryptée</a> avant d’être envoyée à la base de données externe.</td>
</tr>
<tr>
<td>`callback`</td>
<td>Fonction</td>
<td>Utilisée pour passer des données ou des données de résultat d’opération à travers le pipeline.</td>
</tr>
</tbody>
</table>

### Exemple

Voici un exemple fictif en JavaScript de la manière dont vous pourriez implémenter la fonction  `changePassword`. Pour voir des exemples propres à une langue, consulter [Exemples de scripts propres à une langue](#language-specific-script-examples).

```javascript lines
function changePassword(email, newPassword, callback) {
  // Hash the provided password 
  let hashedPassword = hash(newPassword);

  // Prepare the API call
  let options = {
    url: "https://example.com/api/users",
    body: {
      email: email,
      password: hashedPassword
    }
  };

  // Call the API
  send(options, err => {
    if (err && err.id == "FAIL_CHANGE_PASSWORD") {
      // Return false in callback if password change failed
      return callback(null, false);
    } else if (err) {
      // Return error in callback if other error occurred
      return callback(new Error("My custom error message.");
    } else {
      // Return true in callback if password change operation succeeded
      return callback(null, true);

      // Or return an object containing the `last_password_reset` property 
      // if the password change operation succeeded.
      // If the `last_password_reset` property is present in the object,
      // it will be updated on the user's profile.
      return callback(null, { "last_password_reset": Date.now() });
    }
  });
}
```

### Chiffrement

<Warning>

Évitez d’enregistrer, de stocker ou de transporter le mot de passe n’importe où sous sa forme non cryptée.

</Warning>

Pour éviter toute fuite potentielle de données, cryptez la valeur du mot de passe à l’aide d’une bibliothèque de cryptage de hachage telle que `bcrypt`.

#### Exemple

```javascript lines
bcrypt.hash(password, 10, function (err, hash) {
    if (err) {
        return callback(err);
    } else {
        // Return hashed password
    }
});
```

## Fonction de rappel

La fonction de `callback` accepte deux paramètres et est utilisée pour transmettre des données d’erreur ou indiquer le résultat de l’opération.

### Définition

```javascript lines
callback(error, operationResult | resultObj): function
```

<table class="table"><thead>
<tr>
<th><strong>Paramètre</strong></th>
<th><strong>Type</strong></th>
<th><strong>Requis</strong></th>
<th><strong>Description</strong></th>
</tr>
</thead>
<tbody>
<tr>
<td>`error`</td>
<td>Objet</td>
<td>Requis</td>
<td>Contient les données d’erreur.</td>
</tr>
<tr>
<td>`operationResult`</td>
<td>Boolean</td>
<td>Facultatif</td>
<td>Indique le résultat de l’opération de modification de mot de passe.</td>
</tr>
<tr>
<td>`resultObj`</td>
<td>Objet</td>
<td>Facultatif</td>
<td>Indique que l’opération de modification du mot de passe a réussi. Si la propriété `last_password_reset` est présente, elle sera mise à jour dans le profil de l’utilisateur.</td>
</tr>
</tbody>
</table>

### Retourne un succès

Si l’opération de modification de courriel est réussie, renvoyez la fonction de `callback`, et passez une valeur `null` comme paramètre `error` et une valeur `true` comme paramètre `operationResult`.

#### Exemple

```javascript lines
return callback(null, true);
```

### Renvoie une notification de réussite et met à jour l’attribut last_password_reset.

Si l’opération de modification de courriel est réussie, renvoyez la fonction de `callback`, et passez une valeur `null` comme paramètre `error` et une valeur d’objet `profil` comme paramètre. Si l’attribut `last_password_reset` est fourni dans l’objet, il sera mis à jour dans le profil de l’utilisateur.

#### Exemple

```javascript lines
return callback(null, { "last_password_reset": Date.now() });
```

### Renvoyer un échec

Si l’opération de modification du courriel a échoué, renvoyez la fonction de `callback`, et passez une valeur `null` comme paramètre `error` et une valeur `false` comme paramètre `operationResult`.

#### Exemple

```javascript lines
return callback(null, false);
```

### Renvoyer une erreur

Si une erreur survient, renvoyez la fonction de `callback`, et passer l’information pertinente concernant l’erreur comme paramètre `error`.

#### Exemple

```javascript lines
return callback(new Error("My custom error message."));
```

## Exemples de scripts propres à une langue

Auth0 fournit des exemples de scripts à utiliser avec les langages/technologies ci-dessous :

* [JavaScript](#javascript)
* [Fournisseur d’appartenances ASP.NET (MVC3 – Fournisseurs universels)](#asp-net-membership-provider-mvc3-universal-providers-)
* [Fournisseur d’appartenances ASP.NET (MVC4 – Appartenance simple)](#asp-net-membership-provider-mvc4-simple-membership-)
* [MongoDB](#mongodb)
* [MySQL](#mysql)
* [PostgreSQL](#postgresql)
* [Serveur SQL](#sql-server)
* [Base de données SQL Windows Azure](#windows-azure-sql-database)

### JavaScript

```javascript lines
function changePassword(email, newPassword, callback) {
  // This script should change the password stored for the current user in your
  // database. It is executed when the user clicks on the confirmation link
  // after a reset password request.
  // The content and behavior of password confirmation emails can be customized
  // here: https://manage.auth0.com/#/emails
  // The `newPassword` parameter of this function is in plain text. It must be
  // hashed/salted to match whatever is stored in your database.
  //
  // There are three ways that this script can finish:
  // 1. The user's password was updated successfully:
  //     callback(null, true);
  // 2. The user's password was not updated:
  //     callback(null, false);
  // 3. Something went wrong while trying to reach your database:
  //     callback(new Error("my error message"));
  //
  // If an error is returned, it will be passed to the query string of the page
  // to which the user is being redirected after clicking the confirmation link.
  // For example, returning `callback(new Error("error"))` and redirecting to
  // https://example.com would redirect to the following URL:
  //     https://example.com?email=alice%40example.com&message=error&success=false
  const msg = 'Please implement the Change Password script for this database ' +
    'connection at https://manage.auth0.com/#/connections/database';
  return callback(new Error(msg));
}
```

### Fournisseur d’appartenances ASP.NET (MVC3 – Fournisseurs universels)

```javascript lines
function changePassword(email, newPassword, callback) {
  var crypto = require('crypto');
  var Connection = require('tedious').Connection;
  var Request = require('tedious').Request;
  var TYPES = require('tedious').TYPES
  var connection = new Connection({
    userName:  'the username',
    password:  'the password',
    server:    'the server',
    options: {
      database:  'the db name',
      // encrypt: true   for Windows Azure enable this
    }
  });
  /**
   * hashPassword
   *
   * This function creates a hashed version of the password to store in the database.
   *
   * @password  {[string]}      the password entered by the user
   * @return    {[string]}      the hashed password
   */
  function hashPassword(password, salt) {
    // the default implementation uses HMACSHA256 and since Key length is 64
    // and default salt is 16 bytes, Membership will fill the buffer repeating the salt
    var key = Buffer.concat([salt, salt, salt, salt]);
    var hmac = crypto.createHmac('sha256', key);
    hmac.update(Buffer.from(password, 'ucs2'));
    var hashed = hmac.digest('base64');
    return hashed;
  }
  connection.on('debug', function(text) {
      // if you have connection issues, uncomment this to get more detailed info
      //console.log(text);
  }).on('errorMessage', function(text) {
      // this will show any errors when connecting to the SQL database or with the SQL statements
    console.log(JSON.stringify(text));
  });
  connection.on('connect', function (err) {
    if (err) {
      return callback(err);
    }
    updateMembershipUser(email, newPassword, function(err, wasUpdated) {
      if (err) {
        return callback(err); // this will return a 500
      }
      callback(null, wasUpdated);
    });
  });
  function updateMembershipUser(email, newPassword, callback) {
    var salt            = crypto.randomBytes(16);
    var hashedPassword  = hashPassword(newPassword, salt);
    var updateMembership =
      'UPDATE Memberships '+
      'SET Password=@NewPassword, PasswordSalt=@NewSalt, LastPasswordChangedDate=GETDATE() '+
      'WHERE Email=@Email';
    var updateMembershipQuery = new Request(updateMembership, function (membershipErr, membershipCount) {
      if (membershipErr) {
        return callback(membershipErr);
      }
      callback(null, membershipCount > 0);
    });
    updateMembershipQuery.addParameter('NewPassword', TYPES.VarChar, hashedPassword);
    updateMembershipQuery.addParameter('NewSalt',     TYPES.VarChar, salt.toString('base64'));
    updateMembershipQuery.addParameter('Email',       TYPES.VarChar, email);
    connection.execSql(updateMembershipQuery);
  }
}
```

### Fournisseur d’appartenances ASP.NET (MVC4 – Appartenance simple)

```javascript lines
function changePassword(email, newPassword, callback) {
  var crypto = require('crypto');
  var Connection = require('tedious').Connection;
  var Request = require('tedious').Request;
  var TYPES = require('tedious').TYPES
  var connection = new Connection({
    userName:  'the username',
    password:  'the password',
    server:    'the server',
    options: {
      database:  'the db name',
      // encrypt: true for Windows Azure enable this
    }
  });
  /**
   * hashPassword
   *
   * This function hashes a password using HMAC SHA256 algorithm.
   *
   * @password    {[string]}    password to be hased
   * @salt        {[string]}    salt to be used in the hashing process
   * @callback    {[function]}  callback to be called after hashing the password
   */
  function hashPassword(password, salt, callback) {
    var iterations         = 1000;
    var passwordHashLength = 32;
    crypto.pbkdf2(password, salt, iterations, passwordHashLength, function (err, hashed) {
      if (err) {
        return callback(err);
      }
      var result = Buffer.concat([Buffer.from([0], 1), salt, Buffer.from(hashed, 'binary')]);
      var resultBase64 = result.toString('base64');
      callback(null, resultBase64);
    });
  }
  connection.on('debug', function(text) {
      // if you have connection issues, uncomment this to get more detailed info
      //console.log(text);
  }).on('errorMessage', function(text) {
      // this will show any errors when connecting to the SQL database or with the SQL statements
    console.log(JSON.stringify(text));
  });
  connection.on('connect', function (err) {
    if (err) {
      return callback(err);
    }
    updateMembershipUser(email, newPassword, function(err, wasUpdated) {
      if (err) {
        return callback(err); // this will return a 500
      }
      callback(null, wasUpdated);
    });
  });
  function findUserId(email, callback) {
    var findUserIdFromEmail =
      'SELECT UserProfile.UserId FROM ' +
      'UserProfile INNER JOIN webpages_Membership ' +
      'ON UserProfile.UserId = webpages_Membership.UserId ' +
      'WHERE UserName = @Email';
    var findUserIdFromEmailQuery = new Request(findUserIdFromEmail, function (err, rowCount, rows) {
      if (err) {
        return callback(err);
      }
      // No record found with that email
      if (rowCount < 1) {
        return callback(null, null);
      }
      var userId = rows[0][0].value;
      callback(null, userId);
    });
    findUserIdFromEmailQuery.addParameter('Email', TYPES.VarChar, email);
    connection.execSql(findUserIdFromEmailQuery);
  }
  function updateMembershipUser(email, newPassword, callback) {
    findUserId(email, function (err, userId) {
      if (err) {
        return callback(err);
      }
      if (userId === null) {
        return callback();
      }
      var salt = crypto.randomBytes(16);
      var updateMembership =
        'UPDATE webpages_Membership '+
        'SET Password=@NewPassword, PasswordChangedDate=GETDATE() '+
        'WHERE UserId=@UserId';
      var updateMembershipQuery = new Request(updateMembership, function (err, rowCount) {
        if (err) {
          return callback(err);
        }
        if (rowCount < 1) {
          return callback();
        }
        callback(null, rowCount > 0);
      });
      hashPassword(newPassword, salt, function (err, hashedPassword) {
        if (err) {
          return callback(err);
        }
        updateMembershipQuery.addParameter('NewPassword',   TYPES.VarChar, hashedPassword);
        updateMembershipQuery.addParameter('UserId',        TYPES.VarChar, userId);
        connection.execSql(updateMembershipQuery);
      });
    });
  }
}
```

### MongoDB

```javascript lines
function changePassword(email, newPassword, callback) {
  const bcrypt = require('bcrypt');
  const MongoClient = require('mongodb@3.1.4').MongoClient;
  const client = new MongoClient('mongodb://user:pass@mymongoserver.com');
  client.connect(function (err) {
    if (err) return callback(err);
    const db = client.db('db-name');
    const users = db.collection('users');
    bcrypt.hash(newPassword, 10, function (err, hash) {
      if (err) {
        client.close();
        return callback(err);
      }
      users.update({ email: email }, { $set: { password: hash } }, function (err, count) {
        client.close();
        if (err) return callback(err);
        callback(null, count > 0);
      });
    });
  });
}
```

### MySQL

```javascript lines
function changePassword(email, newPassword, callback) {
  const mysql = require('mysql');
  const bcrypt = require('bcrypt');
  const connection = mysql({
    host: 'localhost',
    user: 'me',
    password: 'secret',
    database: 'mydb'
  });
  connection.connect();
  const query = 'UPDATE users SET password = ? WHERE email = ?';
  bcrypt.hash(newPassword, 10, function(err, hash) {
    if (err) return callback(err);
    connection.query(query, [ hash, email ], function(err, results) {
      if (err) return callback(err);
      callback(null, results.length > 0);
    });
  });
}
```

### PostgreSQL

```javascript lines
function changePassword (email, newPassword, callback) {
  //this example uses the "pg" library
  //more info here: https://github.com/brianc/node-postgres
  const bcrypt = require('bcrypt');
  const postgres = require('pg');
  const conString = 'postgres://user:pass@localhost/mydb';
  postgres.connect(conString, function (err, client, done) {
    if (err) return callback(err);
    bcrypt.hash(newPassword, 10, function (err, hash) {
      if (err) return callback(err);
      const query = 'UPDATE users SET password = $1 WHERE email = $2';
      client.query(query, [hash, email], function (err, result) {
        // NOTE: always call `done()` here to close
        // the connection to the database
        done();
        return callback(err, result && result.rowCount > 0);
      });
    });
  });
}
```

### Serveur SQL

```javascript lines
function changePassword (email, newPassword, callback) {
  //this example uses the "tedious" library
  //more info here: http://tediousjs.github.io/tedious/
  const bcrypt = require('bcrypt');
  const sqlserver = require('tedious@1.11.0');
  const Connection = sqlserver.Connection;
  const Request = sqlserver.Request;
  const TYPES = sqlserver.TYPES;
  const connection = new Connection({
    userName:  'test',
    password:  'test',
    server:    'localhost',
    options:  {
      database: 'mydb'
    }
  });
  const query = 'UPDATE dbo.Users SET Password = @NewPassword WHERE Email = @Email';
  connection.on('debug', function(text) {
    console.log(text);
  }).on('errorMessage', function(text) {
    console.log(JSON.stringify(text, null, 2));
  }).on('infoMessage', function(text) {
    console.log(JSON.stringify(text, null, 2));
  });
  connection.on('connect', function (err) {
    if (err) return callback(err);
    const request = new Request(query, function (err, rows) {
      if (err) return callback(err);
      callback(null, rows > 0);
    });
    bcrypt.hash(newPassword, 10, function (err, hash) {
      if (err) return callback(err);
      request.addParameter('NewPassword', TYPES.VarChar, hash);
      request.addParameter('Email', TYPES.VarChar, email);
      connection.execSql(request);
    });
  });
}
```

### Base de données Azure SQL Windows

```javascript lines
function changePassword (email, newPassword, callback) {
  //this example uses the "tedious" library
  //more info here: http://pekim.github.io/tedious/index.html
  var Connection = require('tedious@1.11.0').Connection;
  var Request = require('tedious@1.11.0').Request;
  var TYPES = require('tedious@1.11.0').TYPES;
  var bcrypt = require('bcrypt');
  var connection = new Connection({
    userName:  'your-user@your-server-id.database.windows.net',
    password:  'the-password',
    server:    'your-server-id.database.windows.net',
    options:  {
      database: 'mydb',
      encrypt:  true
    }
  });
  var query = 'UPDATE dbo.Users SET Password = @NewPassword ' +
    'WHERE Email = @Email';
  connection.on('debug', function(text) {
    // Uncomment next line in order to enable debugging messages
    // console.log(text);
  }).on('errorMessage', function(text) {
    console.log(JSON.stringify(text, null, 2));
  }).on('infoMessage', function(text) {
    // Uncomment next line in order to enable information messages
    // console.log(JSON.stringify(text, null, 2));
  });
  connection.on('connect', function (err) {
    if (err) { return callback(err); }
    var request = new Request(query, function (err, rows) {
      if (err) { return callback(err); }
      console.log('rows: ' + rows);
      callback(null, rows > 0);
    });
    bcrypt.hash(newPassword, 10, function (err, hash) {
      if (err) { return callback(err); }
      request.addParameter('NewPassword', TYPES.VarChar, hash);
      request.addParameter('Email', TYPES.VarChar, email);
      connection.execSql(request);
    });
  });
}
```

## En savoir plus

* [Créer des modèles de script](/docs/fr-ca/authenticate/database-connections/custom-db/templates/create)
* [Modèles de script de suppression](/docs/fr-ca/authenticate/database-connections/custom-db/templates/delete)
* [Modèles de script Get User](/docs/fr-ca/authenticate/database-connections/custom-db/templates/get-user)
* [Modèles de script de connexion](/docs/fr-ca/authenticate/database-connections/custom-db/templates/login)
* [Modèles de scripts Verify](/docs/fr-ca/authenticate/database-connections/custom-db/templates/verify)
* [Modifier le modèle de script de courriel](/docs/fr-ca/authenticate/database-connections/custom-db/templates/change-email)