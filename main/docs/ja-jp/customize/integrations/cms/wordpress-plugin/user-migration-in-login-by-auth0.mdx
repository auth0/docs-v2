---
og:description: Describes the user migration feature of the Login by Auth0 WordPress
  Plugin
og:image: https://cdn2.auth0.com/docs/1.14553.0/img/share-image.png
og:title: WordPressプラグインのLogin by Auth0でユーザーを移行する
og:url: https://auth0.com/docs/
permalink: user-migration-in-login-by-auth0
title: WordPressプラグインのLogin by Auth0でユーザーを移行する
twitter:description: Describes the user migration feature of the Login by Auth0 WordPress
  Plugin
twitter:title: WordPressプラグインのLogin by Auth0でユーザーを移行する
---

The User Migration functionality uses a core Auth0 feature called Custom Databases combined with URL endpoints in the Login by Auth0 plugin to allow users to authenticate with existing WordPress user accounts. To learn more about custom databases, read [Custom Database Connections](/docs/authenticate/database-connections/custom-db).

## 仕組み

データ移行を有効にすると、プラグインは2つの安全なエンドポイントを公開し、Auth0がWordPressアカウントを使用してユーザーを認証できるようにします。これらのエンドポイントはシークレットトークンで保護されており、Auth0が使用するIPアドレスのみを許可するように設定できます。

ログイン フローは次のとおりです。

1. A user attempts to login with an Auth0 login form (embedded on your site or hosted at Auth0).
2. If Auth0 can't find a user associated with the provided credentials in your database connection, it proceeds to call the Migration endpoint on your WordPress site with the user credentials and the migration token.
3. The plugin finds a user in your WordPress database with the provided username/email and verifies the password.
4. If a user can be successfully authenticated, Auth0 creates the user in the database connection for your site, authenticates the user, and logs them in.
5. The next time the user logs in, they will use the Auth0 user, and the Migration endpoint will be skipped.

ユーザー移行は、サイトが最初にAuth0に接続されたときに設定する必要があります。ユーザーが既に存在するデータベース接続のカスタムデータベーススクリプトをオンまたはオフにしようとすると失敗します。モード間の移動の詳細については、**トラブルシューティング**のセクションを参照してください。

## セットアップと構成

The easiest way to construct User Migration is to use the Setup Wizard when the plugin is first installed. To learn more about the process, read [Install Login by Auth0](/docs/customize/integrations/cms/wordpress-plugin/install-login-by-auth0).

ユーザー移行セットアップウィザードを完了できなかった場合、またはプロセスを詳しく確認したい場合は、以下の手順に従ってください。これもユーザーがいないデータベース接続でゼロから開始します。次のプロセスは、トラフィックのないサイトまたはメンテナンスモードがオンになっているサイトで完了する必要があります。

1. [Create and correctly configure an Application](/docs/customize/integrations/cms/wordpress-plugin/configure-login-by-auth0), and create and activate an empty Database Connection for the Application. These can be the same as the ones created in the standard Setup Wizard process, or you can create these from scratch. To learn more about the Setup Wizard, read [Install Login by Auth0](/docs/customize/integrations/cms/wordpress-plugin/install-login-by-auth0).
2. In the **Auth0 > Settings** screen in WordPress, make sure the Application's Domain, Client ID and Client Secret are saved in the correct fields in the **Basic** tab.
3. In the **Advanced** view, enable the **User Migration Endpoints** setting, and select **Save Changes**. If you are using constant-based settings, set `AUTH0_ENV_MIGRATION_WS` to `true` and `AUTH0_ENV_MIGRATION_TOKEN` to a secure random string at least 16 digits long and without single quotes or backslashes.
4. Under the settings, you should now see a **Security Token**. Keep this page open as you will need this value later on in the process.
5. In the Auth0 Dashboard, go to the Database Connection you want to use and enable **Requires Username** and **Import Users to Auth0**.
6. Select the **Custom Database view**, and enable **Use my own database**.
7. There should be two tabs below this setting under **Database Action Scripts**: one for **Login** and one for **Get User**.
8. Select the **Login** view, clear out the existing code, [copy the db-login.js code from the GitHub repository](https://raw.githubusercontent.com/auth0/wp-auth0/4.4.0/lib/scripts-js/db-login.js), and paste it into the code editor.
9. **This step is for versions 3.10.0 and earlier:** Look for `{THE_WS_URL}` and replace that with your WordPress instance's site URL, followed by `/index.php?a0_action=migration-ws-login`. The site URL can be found in the **Settings > General** screen in wp-admin. You can test this by pasting the complete URL in your browser. You should see `{"status":401,"error":"Unauthorized"}`.
10. **This step is for versions 3.10.0 and earlier:** Look for `{THE_WS_TOKEN}` and replace that with the token that appears under the **User Migration Endpoints** setting.
11. There should be no errors in the editor. If everything looks good, click **Save** at the top.
12. **This step is for 3.11.0 and later:** Scroll down to **Settings** and add the following configuration variables:
    - `endpointUrl`をWordPressインスタンスのサイトURL（**wp-admin > ［Settings（設定）］ > ［General（一般）］ > 「サイトURL」フィールド**に設定し、その後に`/index.php?a0_action=`を続けます。
    - `migrationToken`を上記の手順4で確認したセキュリティトークンの値に設定します。
    - `userNamespace`をAuth0のアプリケーション名に設定するか、文字、数字、ダッシュのみを含むその他の値に設定します。

    <Frame>![WordPress Plugin custom database settings](/images/cdy7uua7fh8z/1icr0yX47nODUrzP7B6Xl2/b43621c3b6641f68bcb14ac38b237c11/auth0-custom-database-config.png)</Frame>
13. Click the **Try** button at the top and use a valid WordPress user account in the form that appears. You should see the "The profile is" followed by the user's data. If not, please see the **Troubleshooting** section below.
14. Select the **Get User** view, clear out the existing code, [copy the db-get-user.js code from the GitHub repository](https://raw.githubusercontent.com/auth0/wp-auth0/4.4.0/lib/scripts-js/db-get-user.js), and paste it into the code editor.
15. **This step is for 3.10.0 and earlier:** Look for `{THE_WS_URL}` and replace that with your WordPress instance's site URL, followed by /index.php?a0_action=`migration-ws-get-user`. The site URL can be found in the **Settings > General** screen in wp-admin. You can test this by pasting the complete URL in your browser. You should see `{"status":401,"error":"Unauthorized"}`.
16. **This step is for 3.10.0 and earlier:** Look for `{THE_WS_TOKEN}` and replace that with the token that appears under the **User Migration Endpoints** setting.
17. There should be no errors in the editor. If everything looks good, click **Save**.
18. Click the **Try** button at the top and use an email with a valid WordPress user account in the form that appears. You should see the "The profile is" followed by the user's data. If not, please see the **Troubleshooting** section below.
19. In a new browser session, navigate to a login page on the WordPress site and attempt to log in (the user should not already exist in the database). You'll notice that the login process takes a little longer than usual at first, but it should succeed. Subsequent logins will be faster.
20. (OPTIONAL) To turn on additional security for the migration endpoints, go to **Auth0 > Settings** screen in WordPress, turn on, then **Save Changes**. Attempt to log in with a different user to test that Auth0 can still reach the endpoints.

この時点で、ユーザー移行のセットアップは完了し、既存のWordPressユーザーはAuth0データベース接続に徐々に移行されます。

## トラブルシューティング

ユーザー移行の問題は通常、複数の場所で発生します。

* カスタムデータベーススクリプトのURLまたはトークンが正しくありません。
* IP許可リストがオンになっていますが、IPアドレスが正しくありません。
* WordPressインスタンス上の制限されたエンドポイントまたはキャッシュされたエンドポイントです。

The best way to start troubleshooting the issue is to use the **Try** button for the **Login** script found in the Custom Database view of the Database Connection being used on [Auth0 Dashboard > Authentication > Database](https://manage.auth0.com/#/connections/database). The following are the error messages you might see and the steps to take to fix.

### 位置0の JSON に予期しないトークン\<があります

これは、カスタムスクリプトが使用可能な形式でデータを取得していないことを意味します。データベーススクリプトでこの問題が発生する原因は、エンドポイントURLが正しくないことが考えられます。

まず、スクリプトの10行目にあるURLをコピーして、ブラウザーに貼り付けます。エンドポイントが正しい場合は、次の2つのメッセージのいずれかが表示されます。

`{"status":401,"error":"Unauthorized"}`

`// or`

`{"status":403,"error":"Forbidden"}`

表示されているのがホームページまたは404である場合、URLは正しくありません。WordPress管理画面の**［Settings（設定）］ > ［General（一般）］ > ［Site（サイト）URL］**でサイトURLを探します。ログインスクリプトの場合は末尾に`/index.php?a0_action=migration-ws-login`を追加し、ユーザー取得スクリプトの場合は末尾に`/index.php?a0_action=migration-ws-get-user`を追加します。

- **バージョン3.10.0以前の場合**:URLの値は、`request.post`呼び出しの最初のパラメーターとしてスクリプト自体に表示されます。
- **バージョン3.11.0以降の場合**:トークン値は構成変数に保存されます。関数の最初の行に以下を追加し、**［Try（試行）］**ボタンを使用して、`endpointUrl`に保存されている内容を確認します。

`callback(null, configuration);`

URLが正しいことがわかっていてもこの問題が解決しない場合は、ホストに問い合わせて、それらのURLがキャッシュされていないか、何らかの方法で制限されていないかを確認してください。

### メールアドレスまたはパスワードが間違っています

これは、他に問題が発生した場合に表示されるデフォルトのエラーです。現在の問題をトラブルシューティングする最も簡単な方法は、返送されているエラーを一時的に出力することです (これらは、攻撃者に攻撃の材料を与える可能性のあるものを表示しないように、デフォルトでは不透明になっています)。

ログインスクリプトの30行目で、次の内容を変更します。

`callback(null);`

to:

`callback(wpUser.error);`

スクリプトを保存し、再度接続を試みます。次のいずれかのメッセージが表示され、以下の手順で問題を特定できるようになっています。問題を解決したら、スクリプトを元に戻します。

### Forbidden（禁止）

これは、WordPressインストールで移行エンドポイントがオフになっていることを意味します。WordPressで、**Auth0 > Settings（設定） > Advanced（詳細）**に移動し、**User Migration Endpoints（ユーザー移行エンドポイント）**をオンにします。そこに表示されるトークンが、両方のカスタムデータベーススクリプトで使用されているトークンと同じであることを確認します。

* **バージョン3.10.0以前の場合**:トークン値は、スクリプト自体の`access_token`の後に表示される必要があります。
* **バージョン3.11.0以降の場合**:トークン値は構成変数に保存されます。関数の最初の行に以下を追加し、**［Try（試行）］**ボタンを使用して、`migrationToken`に保存されている内容を確認します。

`callback(null, configuration);`

### Unauthorized（未認可）

これは、移行IP許可リストがオンになっているが、着信IPアドレスがリストにないことを意味します。ログインスクリプトのすぐ下に、IPアドレスのリストが表示されます。

<Frame>![WordPress User Migration - Auth0 IP Addresses](/images/cdy7uua7fh8z/3RnxoRlvXm8FmNfu02fXVn/3672806c9cbf2bfe28503be8b8a63eda/auth0-incoming-ip-addresses.png)</Frame>

これらのIPアドレスがすべて、プラグインの**Auth0 > Settings（設定） > Advanced（詳細）**の下にあるWordPressに表示されていることを確認します。

<Frame>![WordPress User Migration - IP Whitelist](/images/cdy7uua7fh8z/3w6C1IrsSC9hoivpSY122l/d117857524ef8d7872f364d3a7dbabda/migration-ip-whitelist-setting-field.png)</Frame>

If one or more of the IP addresses listed in Auth0 do not appear in WordPress, add the missing ones into the field and save the settings page. Also, [create a post in the Auth0 Community](https://community.auth0.com/tags/wordpress) (and tag it "wordpress") that contains the missing IP address(es), so we can address the issue.

### 承認されていません: 承認ヘッダーがありません

The <Tooltip tip="Security Token: Digitally-signed artifact used to prove that the user was successfully authenticated." cta="View Glossary" href="/docs/glossary?term=security+token">security token</Tooltip> is either missing in the database script (line 16), or your server is not processing the headers correctly. Check the Login script and make sure that the token exists and matches what is in WordPress. If the token is there and correct, then you'll need to talk to your host to enable the `Authorization` header to be parsed. For help with server troubleshooting, read [Apache 2.4 + PHP-FPM and Authorization headers on stackoverflow.com](https://stackoverflow.com/questions/17018586/apache-2-4-php-fpm-and-authorization-headers). To see how the token is retrieved, view the [plugin code in the GitHub repository.](https://github.com/auth0/wp-auth0/blob/master/lib/WP_Auth0_Routes.php#L138)

### 無効なトークン

データベーススクリプトのセキュリティトークンが正しくありません。ログインスクリプトの16行目をチェックして、トークンがWordPressのものと一致していることを確認してください。

### 無効な資格情報

使用されているメールアドレスやパスワードが正しくありません。正しいメールアドレスを入力していること、およびパスワードが正しいことを確認してください。ユーザーパスワードを別のものにリセットして、正しいパスワードであることを確認できます。

### メールを変更できない、またはユーザーデータが正しくない

Auth0テナントで複数のカスタムデータベース接続を使用していて、メールアドレスを変更できない、または間違ったユーザーのユーザーデータが保存されている場合は、Auth0でユーザーIDが重複している可能性があります。この問題は、3.11.0をインストールする新しいサイトでは修正されていますが、それ以前に作成された接続では、次のいずれかを実行して手動で修正する必要があります。

* 保存する必要があるユーザーデータが保存されていない場合 (ログインをサポートするためだけに接続を使用し、メタデータを保存していない場合)、上記の手順（3.11.0の注記を使用）を使用して新しいカスタムデータベース接続を作成し、アプリケーションをこの新しい接続に切り替えることができます（古い接続は必ずオフにしてください）。移行が再開され、ユーザー エクスペリエンスに影響はありません。
* If you do have data in Auth0 that needs to be kept, you can [use our User Import/Export Extension](/docs/manage-users/user-migration/user-import-export-extension) to adjust the user data.
  1. Create a new custom database connection using the steps above (using the 3.11.0 notes).
  2. Export all users from the existing connection (we recommend putting your site in maintenance mode while doing the switch-over, so no users are missed).
  3. Change all user IDs to add the namespace used when creating the new connection. User IDs should go from something like `auth0|123` to `auth0|Your-WP-Site-Name|123`. Adjust all other fields you need to follow the import schema. To learn more, read [Bulk User Import Database Schema and Examples](/docs/manage-users/user-migration/bulk-user-import-database-schema-and-examples).
  4. Turn the new connection on and the old connection off for your application.
  5. Import the new user data into the new connection and test.
* 有料アカウントをお持ちの場合は、サポートチームに連絡してデータベース更新スクリプトを実行し、ユーザーIDを名前空間バージョンに変更し、同時にデータベーススクリプトに名前空間を追加することができます（上記の**セットアップと構成**の手順12）。