---
title: "ASP.NET OWIN Web APIアプリケーションに認可を追加する"
permalink: "interactive"
'description': "このチュートリアルは、標準のJWTミドルウェアを使ってASP.NET OWIN APIアプリケーションに認可を追加する方法を説明します。"
'og:title': "ASP.NET OWIN Web APIアプリケーションに認可を追加する"
'og:description': "このチュートリアルは、標準のJWTミドルウェアを使ってASP.NET OWIN APIアプリケーションに認可を追加する方法を説明します。"
'og:image': "https://cdn2.auth0.com/docs/1.14567.0/media/platforms/asp.png"
'twitter:title': "ASP.NET OWIN Web APIアプリケーションに認可を追加する"
'twitter:description': "このチュートリアルは、標準のJWTミドルウェアを使ってASP.NET OWIN APIアプリケーションに認可を追加する方法を説明します。"
sidebarTitle: ASP.NET Web API (OWIN)
---

import { Recipe, Content, Section, SideMenu, SideMenuSectionItem, SignUpForm } from "/snippets/recipe.jsx";
import { LoggedInForm } from "/snippets/Login.jsx";
import Openidconnectsigningkeyresolver from "/snippets/quickstart/backend/webapi-owin/OpenIdConnectSigningKeyResolver.cs.mdx";
import Scopeauthorizeattribute from "/snippets/quickstart/backend/webapi-owin/ScopeAuthorizeAttribute.cs.mdx";
import Apicontroller from "/snippets/quickstart/backend/webapi-owin/ApiController.cs.mdx";

import {AuthCodeGroup} from "/snippets/AuthCodeGroup.jsx";

export const sections = [
  { id: "アクセス許可を定義する", title: "アクセス許可を定義する" },
  { id: "依存関係をインストールする", title: "依存関係をインストールする" },
  { id: "ミドルウェアを構成する", title: "ミドルウェアを構成する" },
  { id: "トークンの署名を検証する", title: "トークンの署名を検証する" },
  { id: "スコープを検証する", title: "スコープを検証する" },
  { id: "apiエンドポイントを保護する", title: "APIエンドポイントを保護する" }
]

<Recipe>
  <Content>
    Auth0を使用すると、アプリケーションに認可を追加することができます。このガイドは、新規または既存のASP.NET Owin Web APIアプリケーションに`Microsoft.Owin.Security.Jwt`パッケージを使ってAuth0を統合する方法を説明します。

    Auth0 DashboardでAPIをまだ作成していない場合は、対話型のセレクターを使ってAuth0 APIを新規作成します。そうでない場合は、プロジェクトに既存のAPIを選択することができます。

    Auth0 Dashboardを使って初めてAPIをセットアップする場合には、使用の開始ガイドを確認してください。

    それぞれのAuth0 APIにはAPI識別子があり、アプリケーションにアクセストークンの検証で使用されます。

    <Info>
    **Auth0を初めてご利用ですか？** Auth0の仕組みと、OAuth 2.0フレームワークを用いたAPI認証と認可の実装について説明します。
    </Info>

      <Section id={sections[0].id} title={sections[0].title} stepNumber="1">
      アクセス許可は、ユーザーの代わりに、提供されたアクセストークンを使ってどのようにしてリソースにアクセスできるのかを定義できるようにします。たとえば、ユーザーがマネージャーアクセスレベルを持つ場合には、`messages`リソースに対して読み取りアクセスを付与し、管理者アクセスレベルを持つ場合には、書き込みアクセスを付与することができます。

      Auth0 Dashboardの[［API］](https://manage.auth0.com/#/apis)セクションにある**［Permissions（権限）］** ビューで使用可能なアクセス許可を定義することができます。以下の例では`read:messages`スコープを使用します。

      <Frame>![［Auth0 Dashboard］>［Applications（アプリケーション）］>［APIs］>［Specific API（特定のAPI］>［Permissions（権限）］タブ](/docs/images/ja-jp/cdy7uua7fh8z/1s3Yp5zqJiKiSWqbPSezNO/acef814282795bef6921535f044f96e9/Quickstarts_API.png)</Frame>
      </Section>

      <Section id={sections[1].id} title={sections[1].title} stepNumber="2">
      `Microsoft.Owin.Security.Jwt` NuGetパッケージをインストールします。このパッケージには、Auth0のアクセストークンをASP.NET Owin Web APIで使用するために必要なOWIN JWTミドルウェアが含まれています。

      ```
      Install-Package Microsoft.Owin.Security.Jwt
      ```
      </Section>

      <Section id={sections[2].id} title={sections[2].title} stepNumber="3">
      `Startup`クラスの`Configuration`メソッドに移動し、構成した`JwtBearerAuthenticationOptions`を渡して`UseJwtBearerAuthentication`の呼び出しを追加します。

      `JwtBearerAuthenticationOptions`では、Auth0 API識別子を`ValidAudience`プロパティで指定し、Auth0ドメインへのフルパスを`ValidIssuer`として指定する必要があります。`OpenIdConnectSigningKeyResolver`のインスタンスを使用するように`IssuerSigningKeyResolver`を構成して、署名鍵を解決できるようにします。

      <Warning>
      **末尾のスラッシュを忘れてはいけません。**

      `ValidIssuer`に指定したURLの末尾にフォワードスラッシュ（`/`）があることを必ず確認してください。これは、JWTの発行者クレームと一致しなければなりません。この値の構成を誤ると、APIの呼び出しが正しく認証されません。
      </Warning>
      </Section>

      <Section id={sections[3].id} title={sections[3].title} stepNumber="4">
      OWINのJWTミドルウェアはOpen ID Connect Discoveryをデフォルトでは使用しないため、カスタムの`IssuerSigningKeyResolver`を提供する必要があります。

      `OpenIdConnectSigningKeyResolver`クラスを作成し、`GetSigningKey`を実装して、正しい`SecurityKey`が返されることを確認します。このクラスは、`Startup.cs`でミドルウェアを構成する際に、`TokenValidationParameters.IssuerSigningKeyResolver`として使用されます。
      </Section>

      <Section id={sections[4].id} title={sections[4].title} stepNumber="5">
      JWTミドルウェアは、要求に含まれたアクセストークンが有効であることを検証しますが、現時点では、トークンが要求されたリソースへのアクセスに十分な**scope** を持っているのかを確認する手段はありません。

      `System.Web.Http.AuthorizeAttribute`を継承する`ScopeAuthorizeAttribute`という名前のクラスを作成してください。この属性はAuth0テナントが発行した`scope`クレームが存在することを確認し、存在する場合には、`scope`クレームが要求されたスコープを含んでいることを確認します。
      </Section>

      <Section id={sections[5].id} title={sections[5].title} stepNumber="6">
      以下に示されたルートは次の要求で使用することができます：

      - `GET /api/public`：認証を必要としない要求に使用することができます。
      - `GET /api/private`：追加スコープのないアクセストークンを含む認証された要求に使用することができます。
      - `GET /api/private-scoped`：`read:messages`スコープが付与されたアクセストークンを含む認証された要求に使用することができます。

      JWTミドルウェアは標準のASP.NETの認証および認可メカニズムと統合できるため、コントローラーのアクションを`[Authorize]`属性で装飾するだけで、エンドポイントのセキュリティを確保できます。

      アクションを`ScopeAuthorize`属性で更新し、必要な`scope`の名前を`scope`パラメーターに渡します。これにより、特定のAPIエンドポイントを呼び出すために、正しいスコープが利用できることが確実になります。

      <Note>
      ##### チェックポイント
      アプリケーションの構成が完了したら、アプリケーションを実行して次の点を検証します：
      GET /api/public が認証を必要としない要求に使用できる。
      GET /api/private が認証された要求に使用できる。
      GET /api/private-scoped がread:messagesスコープが付与されたアクセストークンを含む認証された要求に使用できる。
      </Note>
      </Section>

    ## 次のステップ

    成功です！ここまで来れば、アプリケーションにログイン、ログアウト、ユーザープロファイル情報が備わっているはずです。

    これでクイックスタートチュートリアルは終了ですが、機能はまだまだたくさんあります。Auth0でできることについて詳しくは、以下をご覧ください。

    *   [Auth0 Dashboard](https://manage.auth0.com/#) - Auth0のテナントやアプリケーションを構成して管理する方法について説明します
    *   [Auth0 Marketplace](https://marketplace.auth0.com/) - Auth0の機能性を拡張できる各種の統合を見つけられます
  </Content>

  <SideMenu sections={sections}>
      <SideMenuSectionItem id={sections[0].id}>
        <SignUpForm />
      </SideMenuSectionItem>

      <SideMenuSectionItem id={sections[1].id}>
        <SignUpForm />
      </SideMenuSectionItem>

      <SideMenuSectionItem id={sections[2].id}>
      <AuthCodeGroup>
        <Openidconnectsigningkeyresolver />
        <Scopeauthorizeattribute />
        <Apicontroller />
      </AuthCodeGroup>
      </SideMenuSectionItem>

      <SideMenuSectionItem id={sections[3].id}>
      <AuthCodeGroup>
        <Openidconnectsigningkeyresolver />
        <Scopeauthorizeattribute />
        <Apicontroller />
      </AuthCodeGroup>
      </SideMenuSectionItem>

      <SideMenuSectionItem id={sections[4].id}>
      <AuthCodeGroup>
        <Scopeauthorizeattribute />
        <Openidconnectsigningkeyresolver />
        <Apicontroller />
      </AuthCodeGroup>
      </SideMenuSectionItem>

      <SideMenuSectionItem id={sections[5].id}>
      <AuthCodeGroup>
        <Apicontroller />
        <Openidconnectsigningkeyresolver />
        <Scopeauthorizeattribute />
      </AuthCodeGroup>
      </SideMenuSectionItem>

    </SideMenu>
</Recipe>
