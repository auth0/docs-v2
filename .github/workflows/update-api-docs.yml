name: Automated OpenAPI Spec Update

on:
  # Allows manual triggering and selection of branch from the Actions tab
  workflow_dispatch:
  
  # *** ADDED: This trigger ensures the workflow appears and runs when you push to ANY branch ***
  push:
    branches:
      - '*'
      
  # Runs the workflow on a daily schedule
  schedule:
    - cron: '0 0 * * *'

jobs:
  generate_and_scrape:
    runs-on: ubuntu-latest
    
    # Permissions are required for the auto-commit action to push changes back
    permissions:
      contents: write

    steps:
    - name: ‚¨áÔ∏è Checkout docs-v2 (This) Repository
      uses: actions/checkout@v4
      with:
        path: docs-v2
        fetch-depth: 0

    - name: ‚¨áÔ∏è Checkout api2 Source Repository
      uses: actions/checkout@v4
      with:
        repository: atko-cic/api2 # <<< VERIFY THIS REPO PATH
        path: api2

    - name: üõ†Ô∏è Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '20'

    - name: üì¶ Install dependencies in api2
      run: |
        cd api2
        npm ci

    - name: ‚öôÔ∏è Generate OAPI Spec
      run: |
        cd api2
        npm run spec:generate -w packages/main-api

    - name: üìù Copy and Modify OpenAPI Spec for Mintlify
      run: |
        # 1. Copy the generated file to the docs location
        cp api2/api2.json docs-v2/main/docs/api2-3.1-internal.json
        
        # 2. Perform the tokenUrl replacement
        sed -i 's|"tokenUrl": "https://{tenantDomain}/oauth/token"|"tokenUrl": "https://your-tenant-domain.auth0.com/oauth/token"|g' docs-v2/main/docs/api2-3.1-internal.json
        
    - name: üßπ Scrape OpenAPI to MDX files
      run: |
        cd docs-v2/main
        npx @mintlify/scraping@latest openapi-file docs/api2-3.1-internal.json -o api-reference

    - name: üíæ Commit and Push generated files
      uses: stefanzweifel/git-auto-commit-action@v5
      with:
        repository: docs-v2
        commit_message: "Automated: Update API reference from latest api2 spec"
        commit_user_name: 'GitHub Actions Bot'
        commit_user_email: 'actions@github.com'
