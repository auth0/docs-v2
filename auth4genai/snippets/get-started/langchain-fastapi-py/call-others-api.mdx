import { Prerequisites } from "/snippets/get-started/prerequisites/call-others-api.jsx";
import { AccountAndAppSteps } from "/snippets/get-started/prerequisites/account-app-steps.jsx";

<Prerequisites
  createAuth0ApplicationStep={{
    applicationType: "Regular Web Applications",
    callbackUrl: "http://localhost:8000/api/auth/callback",
    logoutUrl: "http://localhost:5173",
  }}
/>

<Tabs>
  <Tab
    title="Use sample app (recommended)"
  >
  
### Clone sample app
Clone this sample app from the [Auth0 AI samples](https://github.com/auth0-samples/auth0-ai-samples) repository:

```bash wrap lines
git clone https://github.com/auth0-samples/auth0-ai-samples.git
cd auth0-ai-samples/call-apis-on-users-behalf/others-api/langchain-fastapi-py
```

The project is divided into two parts:

- `backend/`: contains the backend code for the web app, an API written in Python using FastAPI and the LangGraph agent.
- `frontend/`: contains the frontend code for the web app, written in React as a Vite SPA.

### Install backend packages

In the `backend` directory of your project, install the required packages using your preferred package manager, such as `uv`. You can find the instructions on how to [install uv](https://docs.astral.sh/uv/getting-started/installation/) in its documentation.

```bash wrap lines
cd backend
uv sync
```

### Create your environment file

In the `backend` directory of your project, create a new file and name it `.env` and add the following content:

```bash .env wrap lines
# Auth0 configuration
APP_BASE_URL='http://localhost:8000'
AUTH0_SECRET='random 32 byte value'
AUTH0_DOMAIN='<your-auth0-domain>'
AUTH0_CLIENT_ID='<your-auth0-application-client-id>'
AUTH0_CLIENT_SECRET='<your-auth0-application-client-secret>'

# OpenAI API Key or any provider supported by the Vercel AI SDK
OPENAI_API_KEY="YOUR_API_KEY"

# LANGGRAPH
LANGGRAPH_API_URL=http://localhost:54367
```

To get your Auth0 application's `AUTH0_DOMAIN`, `AUTH0_CLIENT_ID`, and `AUTH0_CLIENT_SECRET`, navigate to the **Settings** tab in the Auth0 Dashboard. You'll find these values in the **Basic Information** section at the top.
Copy each value to the matching setting.

Next, run this command to generate a random 32 byte value and copy it to the `AUTH0_SECRET` field:
```bash generate random 32 byte value
openssl rand -hex 32
```

Lastly, set your OpenAI API key or use any provider supported by the Vercel AI SDK:
```bash .env.local wrap lines
OPENAI_API_KEY="YOUR_API_KEY"
```

### Install frontend packages

Ensure you have `npm` installed or follow the instructions to [install npm](https://docs.npmjs.com/downloading-and-installing-node-js-and-npm) in its documentation.
Navigate to the `frontend` directory of your project and install the required packages:

```bash wrap lines
cd frontend
npm install
```

### Run your application

To run your application, start the FastAPI backend, LangGraph server, and the frontend in three terminals:

1. In one terminal, start the FastAPI backend:

```bash wrap lines
cd backend
source .venv/bin/activate
uv pip install auth0_fastapi
fastapi dev app/main.py
```

2. In a second new terminal, start the LangGraph server:

```bash wrap lines
cd backend
source .venv/bin/activate
uv pip install -U langgraph-api
langgraph dev --port 54367 --allow-blocking
```
<Note>
  This opens LangGraph Studio in a new tab. You can safely close it.
</Note>

3. In a third new terminal, start the frontend:

```bash wrap lines
cd frontend
cp .env.example .env # Copy the `.env.example` file to `.env`.
npm install
npm run dev
```

Visit the URL `http://localhost:5173` in your browser. If you are already logged in, make sure to log out and log back in using Google. Now ask your AI agent to list the upcoming events in your Google Calendar!

That's it! You successfully called a third-party API using Token Vault.

</Tab>
  <Tab
    title="Integrate into your app"
  >
### Install packages
In the `backend` directory of your project, install the following dependencies:

- `auth0-ai-langchain`: [Auth0 AI SDK for LangChain](https://github.com/auth0-lab/auth0-ai-python/tree/main/packages/auth0-ai-langchain) built for AI agents powered by LangChain.
- `langgraph`: [LangGraph](https://pypi.org/project/langgraph/) for building stateful, multi-actor applications with LLMs.
- `langchain-openai`: LangChain integrations for OpenAI.
- `langgraph-cli`: LangGraph CLI for running a local LangGraph server.
- `google-api-python-client`: Google API client library for Python.

Make sure you have [uv](https://docs.astral.sh/uv/) installed and run the following command to install the dependencies:

```bash wrap lines
cd backend
uv sync
uv add "auth0-ai-langchain>=1.0.0b3" "langgraph>=0.5.4" langchain-openai "langgraph-cli[inmem]" google-api-python-client --prerelease=allow
```

### Update your environment file
In the `backend` directory of your project, add the following variables to your environment file:

```bash .env wrap lines
# Auth0 configuration
APP_BASE_URL='http://localhost:8000'
AUTH0_SECRET='random 32 byte value'
AUTH0_DOMAIN='<your-auth0-domain>'
AUTH0_CLIENT_ID='<your-auth0-application-client-id>'
AUTH0_CLIENT_SECRET='<your-auth0-application-client-secret>'

# OpenAI API Key or any provider supported by the Vercel AI SDK
OPENAI_API_KEY="YOUR_API_KEY"

# LANGGRAPH
LANGGRAPH_API_URL=http://localhost:54367
```

To get your Auth0 application's `AUTH0_DOMAIN`, `AUTH0_CLIENT_ID`, and `AUTH0_CLIENT_SECRET`, navigate to the **Settings** tab in the Auth0 Dashboard. You'll find these values in the **Basic Information** section at the top.
Copy each value to the matching setting.

Next, run this command to generate a random 32 byte value and copy it to the `AUTH0_SECRET` field.
```bash generate random 32 byte value
openssl rand -hex 32
```

Lastly, set your OpenAI API key or use any provider supported by the Vercel AI SDK.

### Set up Token Vault for Google social connection

Use the [Auth0 AI SDK for LangChain](https://github.com/auth0-lab/auth0-ai-js/tree/main/packages/ai-langchain) to get an access token for the [Google Social Connection](/integrations/google) using [Token Vault](https://auth0.com/docs/secure/tokens/token-vault):

- `connection`: pass in the name of the connection you want to access.
- `scopes`: pass in the scopes to be authorized for this connection.

Create a file at `app/core/auth0_ai.py` to instantiate the Auth0 AI SDK client:

```python app/core/auth0_ai.py wrap lines
from auth0_ai.authorizers.types import Auth0ClientParams
from auth0_ai_langchain.auth0_ai import Auth0AI
from langchain_core.runnables import ensure_config

from app.core.config import settings

auth0_ai = Auth0AI(
    Auth0ClientParams(
        {
            "domain": settings.AUTH0_DOMAIN,
            "client_id": settings.AUTH0_CLIENT_ID,
            "client_secret": settings.AUTH0_CLIENT_SECRET,
        }
    )
)

with_calendar_access = auth0_ai.with_federated_connection(
    connection="google-oauth2",
    scopes=["https://www.googleapis.com/auth/calendar.events"],
)
```

### Pass credentials to the AI agent

Update your API route to pass the user session data and an external provider's access token to the AI agent, for example, in `app/api/routes/chat.py`:

```python app/api/routes/chat.py wrap lines highlight={2,9,21}
# ...
from app.core.auth import auth_client
# ...

@agent_router.api_route(
    "/{full_path:path}", methods=["GET", "POST", "DELETE", "PATCH", "PUT", "OPTIONS"]
)
async def api_route(
    request: Request, full_path: str, auth_session=Depends(auth_client.require_session)
):
    try:
        # ... existing code

        # Prepare body
        body = await request.body()
        if request.method in ("POST", "PUT", "PATCH") and body:
            content = await request.json()
            content["config"] = {
                "configurable": {
                    "_credentials": {
                        "refresh_token": auth_session.get("refresh_token"),
                    }
                }
            }
            body = json.dumps(content).encode("utf-8")

            # ... existing code
```

### Use access token to call APIs from a tool

Once the user is authenticated, you can fetch an access token from Token Vault using the Auth0 AI SDK. In this example, we fetch an access token for a Google social connection.
Once you've obtained the access token for a connection, you can use it with an AI agent to fetch data during a tool call and provide contextual data in its response.

Create or update a tool similar to this example that creates a Google Calendar query tool:

```python app/agents/tools/google_calendar.py wrap lines
from langchain_core.tools import StructuredTool
from google.oauth2.credentials import Credentials
from googleapiclient.discovery import build
from pydantic import BaseModel
from auth0_ai_langchain.federated_connections import (
    get_access_token_for_connection,
)
import datetime
import json

from app.core.auth0_ai import with_calendar_access

async def list_upcoming_events_fn():
    """List upcoming events from the user's Google Calendar"""
    google_access_token = get_access_token_for_connection()
    if not google_access_token:
        raise ValueError(
            "Authorization required to access the Federated Connection API"
        )

    calendar_service = build(
        "calendar",
        "v3",
        credentials=Credentials(google_access_token),
    )

    events = (
        calendar_service.events()
        .list(
            calendarId="primary",
            timeMin=datetime.datetime.now().isoformat() + "Z",
            timeMax=(datetime.datetime.now() + datetime.timedelta(days=7)).isoformat()
            + "Z",
            maxResults=5,
            singleEvents=True,
            orderBy="startTime",
        )
        .execute()
        .get("items", [])
    )

    return json.dumps(
        [
            {
                "summary": event["summary"],
                "start": event["start"].get("dateTime", event["start"].get("date")),
            }
            for event in events
        ]
    )

list_upcoming_events = with_calendar_access(
    StructuredTool(
        name="list_upcoming_events",
        description="List upcoming events from the user's Google Calendar",
        args_schema=BaseModel,
        coroutine=list_upcoming_events_fn,
    )
)
```

### Add the tool to the AI agent
If you created a new tool, ensure it's added to the list of tools used by your AI agent. For example:

```python app/agents/assistant0.py wrap lines highlight={2,4}
# ...
from app.agents.tools.google_calendar import list_upcoming_events

tools = [list_upcoming_events]

llm = ChatOpenAI(model="gpt-4.1-mini")

# ... existing code
agent = create_react_agent(
    llm,
    tools=ToolNode(tools, handle_tool_errors=False),
    prompt=get_prompt(),
)
```

### Add step-up authorization

When you try to use the tool, the application requests any additional Google scopes that are required but not yet authorized. This process is called step-up authorization.

To implement, install the Auth0 AI Components for React SDK to get the required UI components:

```bash wrap lines
cd frontend
npm install @auth0/ai @langchain/langgraph-sdk
npx @auth0/ai-components add FederatedConnections
```

Add a new file, `src/components/auth0-ai/FederatedConnections/FederatedConnectionInterruptHandler.tsx`, with the following code:

```tsx src/components/auth0-ai/FederatedConnections/FederatedConnectionInterruptHandler.tsx wrap lines
import { FederatedConnectionInterrupt } from "@auth0/ai/interrupts";
import type { Interrupt } from "@langchain/langgraph-sdk";

import { EnsureAPIAccess } from "@/components/auth0-ai/FederatedConnections";

interface FederatedConnectionInterruptHandlerProps {
  interrupt: Interrupt | undefined | null;
  onFinish: () => void;
  auth?: {
    authorizePath?: string;
    returnTo?: string;
  };
}

export function FederatedConnectionInterruptHandler({
  interrupt,
  onFinish,
  auth,
}: FederatedConnectionInterruptHandlerProps) {
  if (
    !interrupt ||
    !FederatedConnectionInterrupt.isInterrupt(interrupt.value)
  ) {
    return null;
  }

  return (
    <div key={interrupt.ns?.join("")} className="whitespace-pre-wrap">
      <EnsureAPIAccess
        mode="popup"
        interrupt={interrupt.value}
        onFinish={onFinish}
        auth={auth}
        connectWidget={{
          title: "Authorization Required.",
          description: interrupt.value.message,
          action: { label: "Authorize" },
        }}
      />
    </div>
  );
}
```

Now, update your chat window code to include the `FederatedConnectionInterruptHandler` component, for example:

```tsx src/components/chat-window.tsx wrap lines highlight={2,3,25-50}
//...
import { FederatedConnectionInterruptHandler } from '@/components/auth0-ai/FederatedConnections/FederatedConnectionInterruptHandler';
import { getLoginUrl } from "@/lib/use-auth";

//... existing code
export function ChatWindow(props: {
  //... existing code
}) {
  //... existing code
  return (
    <StickToBottom>
      <StickyToBottomContent
        className="absolute inset-0"
        contentClassName="py-8 px-2"
        content={
          chat.messages.length === 0 ? (
            <div>{props.emptyStateComponent}</div>
          ) : (
            <>
              <ChatMessages
                aiEmoji={props.emoji}
                messages={chat.messages}
                emptyStateComponent={props.emptyStateComponent}
              />
              <div className="flex flex-col max-w-[768px] mx-auto pb-12 w-full">
                {!!chat.interrupt?.value && (
                  <FederatedConnectionInterruptHandler
                    auth={{
                      authorizePath: getLoginUrl(),
                      returnTo: new URL(
                        "/close",
                        window.location.origin
                      ).toString(),
                    }}
                    interrupt={{
                      ...chat.interrupt,
                      value: {
                        ...chat.interrupt.value,
                        requiredScopes:
                          (
                            chat.interrupt.value as {
                              required_scopes: [string];
                            }
                          ).required_scopes || [],
                      },
                    }}
                    onFinish={() => chat.submit(null)}
                  />
                )}
              </div>
            </>
          )
        }
        {/* ... existing code */}
      ></StickyToBottomContent>
    </StickToBottom>
  );
}
```
Now when step-up authorization is required, the user will see a prompt in the chat window asking them to authorize.

### Test your application
Start your application. If you are already logged in, make sure to log out and log back in using Google. Then, ask your AI agent to list the upcoming events in your Google Calendar!

That's it! You successfully integrated third-party API access using Token Vault into your app.

### View a complete example
Want to see how it all comes together? Explore or clone the fully implemented sample application on [GitHub](https://github.com/auth0-samples/auth0-ai-samples/tree/main/call-apis-on-users-behalf/others-api/langchain-fastapi-py).
</Tab>
</Tabs>