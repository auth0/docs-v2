import { useCallback, useEffect, useState } from "react";

export const CustomTocs = ({ sections, config = {} }) => {
  const [items, setItems] = useState([]);
  const [steperItems, setSteperItems] = useState([]);
  const [guideItems, setGuideItems] = useState([]);
  const headerOffset = config.headerOffset ?? 88;

  const getScrollParent = (el) => {
    if (!el) return window;

    const isFixed = (node) => getComputedStyle(node).position === "fixed";
    const canScrollRe = /(auto|scroll|overlay)/i;
    let node = el;

    while (node && node !== document.body && node !== document.documentElement) {
      const root = node.getRootNode && node.getRootNode();
      if (root && root.host && root.host instanceof HTMLElement && node === root) {
        node = root.host;
        continue;
      }

      const style = getComputedStyle(node);

      if (isFixed(node)) {
        return window;
      }

      const overflowY = style.overflowY || style.overflow;

      if (
        canScrollRe.test(overflowY) &&
        node.scrollHeight > node.clientHeight
      ) {
        return node;
      }

      node = node.parentElement || null;
    }

    return document.scrollingElement || document.documentElement || window;
  };

  const getRootScroller = () =>
    document.scrollingElement || document.documentElement;

  const getOffsetWithin = (el, container) => {
    const er = el.getBoundingClientRect();
    const cr = container.getBoundingClientRect();
    return er.top - cr.top + container.scrollTop;
  };

  const scrollToId = (id) => {
    const el = document.getElementById(id);
    if (!el) return;

    const sp = getScrollParent(el);

    if (sp === window || sp === document.documentElement || sp === document.body) {
      const root = getRootScroller();
      const y = el.getBoundingClientRect().top + root.scrollTop - headerOffset;
      root.scrollTo({ top: y, behavior: "smooth" });
    } else {
      const y = getOffsetWithin(el, sp) - headerOffset;
      sp.scrollTo({ top: y, behavior: "smooth" });
    }
  };

  useEffect(() => {
    let headings = Array.from(document.querySelectorAll("#content-area #content > h2"));

    if (config.includeHeadingsFrom) {
      headings = Array.from(document.querySelectorAll(config.includeHeadingsFrom)).concat(headings);
    }

    headings.forEach(h => (h.style.scrollMarginTop = `${headerOffset}px`));

    let steps = Array.from(document.querySelectorAll(".step [data-component-part='step-title']"));

    if (config.stepperRoot) {
      steps = Array.from(document.querySelectorAll(`${config.stepperRoot} .step [data-component-part='step-title']`));
    }

    steps.forEach(s => (s.style.scrollMarginTop = `${headerOffset}px`));

    const guide = Array.from(document.querySelectorAll(".tabs [data-component-part='tab-content'] h3"));
    guide.forEach(s => (s.style.scrollMarginTop = `${headerOffset}px`));

    if (config.includeTitle) {
      headings.unshift(document.querySelector("h1#page-title"));
    }

    const stepItems = steps.map((h, idx) => {
      if (!h.id) h.id = `step-${idx}`;
      return { id: h.id, text: h.textContent };
    });

    const guideItems = guide.map((h, idx) => {
      if (!h.id) h.id = `step-${idx}`;
      return { id: h.id, text: h.textContent };
    });

    setItems(headings.map(h => ({ id: h.id, text: h.textContent.replace(/â€‹ /g, '').trim() })));
    setSteperItems(stepItems);
    setGuideItems(guideItems);
  }, [headerOffset]);

  return (
    <div className="z-10 hidden xl:flex gap-6 flex-col pl-10 box-border w-[16.5rem] max-h-full text-gray-600 text-sm leading-6 overflow-y-auto pb-4 -mt-10 pt-10">
      <div>
        <h2 className="text-gray-700 dark:text-gray-300 font-medium flex items-center">On this page</h2>
        <ul className="text-[#767676] text-sm mt-4 flex flex-col gap-2">
          {items.map((i, idx) => (
            <li key={i.id}>
              <a
                href={`#${i.id}`}
                onClick={(e) => { e.preventDefault(); scrollToId(i.id); }}
                className="group flex items-start whitespace-pre-wrap focus:outline-primary dark:focus:outline-primary-light text-gray-500 hover:text-gray-900 dark:text-gray-400 dark:hover:text-gray-300"
              >
                {i.text}
              </a>

              {config.elementWithStepper === idx && steperItems.length > 0 && (
                <ol className="text-[#767676] text-sm flex flex-col gap-2 ml-8 list-decimal">
                  {steperItems.map(s => (
                    <li key={s.id || s.text}>
                      <button
                        onClick={() => scrollToId(s.id)}
                        className="group flex items-start whitespace-pre-wrap focus:outline-primary dark:focus:outline-primary-light text-gray-500 hover:text-gray-900 dark:text-gray-400 dark:hover:text-gray-300 text-left"
                      >
                        {s.text}
                      </button>
                    </li>
                  ))}
                </ol>
              )}

              {config.elementIsGuide === idx && guideItems.length > 0 && (
                <ul className="text-[#767676] text-sm flex flex-col gap-2 ml-4 mt-2">
                  {guideItems.map(s => (
                    <li key={s.id || s.text}>
                      <button
                        onClick={() => scrollToId(s.id)}
                        className="group flex items-start whitespace-pre-wrap focus:outline-primary dark:focus:outline-primary-light text-gray-500 hover:text-gray-900 dark:text-gray-400 dark:hover:text-gray-300 text-left"
                      >
                        {s.text}
                      </button>
                    </li>
                  ))}
                </ul>
              )}
            </li>
          ))}
        </ul>
      </div>

      {sections.map((section, idx) => (
        <div
          key={idx}
          className={`border-t ${idx === sections.length - 1 ? "border-b" : ""} dark:border-[#222224] pt-6 last:pb-6`}
        >
          <h2 className="text-gray-700 dark:text-gray-300 font-medium flex items-center">{section.title}</h2>
          <ul className="text-[#767676] text-sm mt-4 flex flex-col gap-2">
            {section.links.map((link, lidx) => (
              <li key={lidx}>
                <a
                  className="group flex items-start whitespace-pre-wrap focus:outline-primary dark:focus:outline-primary-light text-gray-500 hover:text-gray-900 dark:text-gray-400 dark:hover:text-gray-300"
                  href={link.href}
                  target={link.target || "_blank"}
                >
                  {link.label}
                </a>
              </li>
            ))}
          </ul>
        </div>
      ))}
    </div>
  );
};
